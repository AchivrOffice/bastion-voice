<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bastion Voice</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0e1a;color:#e2e8f0;min-height:100vh;overflow-x:hidden}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;border-bottom:1px solid rgba(255,255,255,0.06)}
.logo{font-size:17px;font-weight:700;letter-spacing:1px}.logo span{color:#f59e0b}
.hdr-btn{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#94a3b8;padding:7px 14px;border-radius:8px;cursor:pointer;font-size:12px}
.hdr-btn:hover{background:rgba(255,255,255,0.1);color:#e2e8f0}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:#1a1f2e;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px;max-width:440px;width:90%}
.modal h3{font-size:17px;margin-bottom:6px}
.modal p{font-size:13px;color:#94a3b8;margin-bottom:18px;line-height:1.5}
.modal input{width:100%;padding:11px 14px;background:#0a0e1a;border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#e2e8f0;font-size:13px;font-family:monospace;margin-bottom:14px}
.modal input:focus{outline:none;border-color:#f59e0b}
.m-actions{display:flex;gap:10px}
.btn-p{flex:1;padding:11px;background:#f59e0b;color:#0a0e1a;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer}
.btn-p:hover{background:#d97706}
.btn-s{padding:11px 18px;background:transparent;color:#94a3b8;border:1px solid rgba(255,255,255,0.1);border-radius:8px;font-size:13px;cursor:pointer}

/* SCREENS */
.screen{display:none}.screen.active{display:flex;flex-direction:column;align-items:center}

/* PICK SCREEN */
.pick-wrap{max-width:660px;width:100%;padding:40px 20px}
.pick-wrap h1{font-size:24px;font-weight:700;text-align:center;margin-bottom:4px}
.pick-wrap .sub{color:#94a3b8;font-size:14px;text-align:center;margin-bottom:36px}
.step-label{font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:1.2px;font-weight:600;margin-bottom:10px}
.agents-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
@media(max-width:520px){.agents-row{grid-template-columns:1fr}}
.ag-card{background:#111827;border:2px solid rgba(255,255,255,0.06);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.25s;position:relative;overflow:hidden}
.ag-card:hover{border-color:rgba(245,158,11,0.3)}
.ag-card.sel{border-color:#f59e0b}
.ag-top{display:flex;align-items:center;gap:14px;margin-bottom:10px}
.ag-av{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.08);flex-shrink:0}
.ag-info h3{font-size:15px;margin-bottom:1px}.ag-info .role{color:#f59e0b;font-size:11px;font-weight:500}
.ag-desc{font-size:12px;color:#94a3b8;line-height:1.5;margin-bottom:8px}
.ag-badge{display:inline-block;font-size:10px;font-weight:600;padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:0.5px}
.badge-pro{background:rgba(99,102,241,0.12);color:#818cf8;border:1px solid rgba(99,102,241,0.2)}
.badge-exec{background:rgba(245,158,11,0.12);color:#f59e0b;border:1px solid rgba(245,158,11,0.2)}

/* CONFIG SCREEN */
.config-wrap{max-width:580px;width:100%;padding:36px 20px}
.back-link{color:#94a3b8;font-size:13px;cursor:pointer;margin-bottom:20px;display:inline-flex;align-items:center;gap:6px}
.back-link:hover{color:#e2e8f0}
.config-agent{display:flex;align-items:center;gap:14px;margin-bottom:24px;padding-bottom:18px;border-bottom:1px solid rgba(255,255,255,0.06)}
.config-agent .av{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.08)}
.config-agent h2{font-size:18px}.config-agent .role{color:#f59e0b;font-size:12px}

.cfg-section{margin-bottom:22px}
.cfg-label{font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:1.2px;font-weight:600;margin-bottom:10px}

.goal-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:400px){.goal-grid{grid-template-columns:1fr}}
.goal-chip{background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:12px 14px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:10px;font-size:13px}
.goal-chip:hover{border-color:rgba(245,158,11,0.3)}
.goal-chip.sel{border-color:#f59e0b;background:rgba(245,158,11,0.04)}
.goal-chip .g-icon{font-size:18px;flex-shrink:0}

.scenario-chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.sc-chip{background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:9px 14px;cursor:pointer;transition:all 0.2s;font-size:12px;font-weight:500}
.sc-chip:hover{border-color:rgba(245,158,11,0.3)}
.sc-chip.sel{border-color:#f59e0b;background:rgba(245,158,11,0.04)}
.custom-input{width:100%;padding:11px 14px;background:#111827;border:1px solid rgba(255,255,255,0.08);border-radius:10px;color:#e2e8f0;font-size:13px;font-family:inherit;resize:none;line-height:1.5}
.custom-input:focus{outline:none;border-color:#f59e0b}
.custom-input::placeholder{color:#475569}

/* DIFFICULTY SLIDER */
.diff-wrap{position:relative}
.diff-slider{-webkit-appearance:none;width:100%;height:6px;border-radius:3px;background:linear-gradient(to right,#22c55e 0%,#22c55e 33%,#f59e0b 33%,#f59e0b 66%,#ef4444 66%,#ef4444 100%);outline:none;cursor:pointer;margin:8px 0}
.diff-slider::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:#fff;border:3px solid #0a0e1a;box-shadow:0 0 0 2px rgba(255,255,255,0.3),0 2px 8px rgba(0,0,0,0.3);cursor:pointer;transition:transform 0.15s}
.diff-slider::-webkit-slider-thumb:hover{transform:scale(1.15)}
.diff-slider::-moz-range-thumb{width:24px;height:24px;border-radius:50%;background:#fff;border:3px solid #0a0e1a;box-shadow:0 0 0 2px rgba(255,255,255,0.3);cursor:pointer}
.diff-labels{display:flex;justify-content:space-between;font-size:11px;color:#64748b;margin-top:2px}
.diff-current{text-align:center;font-size:15px;font-weight:700;margin-top:8px;transition:color 0.3s}

.go-btn{display:block;width:100%;padding:15px;background:#f59e0b;color:#0a0e1a;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:8px}
.go-btn:hover{background:#d97706}
.go-btn:disabled{opacity:0.25;cursor:not-allowed}

/* BRIEFING */
.brief-wrap{max-width:520px;width:100%;padding:40px 20px;text-align:center}
.brief-av{width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.1);margin:0 auto 14px}
.brief-wrap h2{font-size:20px;margin-bottom:2px}
.brief-wrap .role{color:#f59e0b;font-size:12px;margin-bottom:24px}
.brief-card{background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:22px;text-align:left;margin-bottom:20px}
.brief-card h3{font-size:13px;color:#f59e0b;margin-bottom:14px;text-transform:uppercase;letter-spacing:0.5px}
.rule{display:flex;gap:10px;margin-bottom:10px;font-size:13px;line-height:1.5;color:#c8d0dc}
.rule .num{width:22px;height:22px;border-radius:50%;background:rgba(245,158,11,0.12);color:#f59e0b;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:1px}
.brief-meta{font-size:13px;color:#94a3b8;line-height:1.6;margin-bottom:24px;padding:16px;background:rgba(255,255,255,0.02);border-radius:10px;text-align:left}
.brief-meta strong{color:#e2e8f0}
.brief-btn{padding:14px 40px;background:#f59e0b;color:#0a0e1a;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer}
.brief-btn:hover{background:#d97706}

/* â•â•â• SESSION â•â•â• */
.sess-outer{width:100%;position:relative}
.sess-wrap{max-width:520px;width:100%;padding:24px 20px;margin:0 auto;display:flex;flex-direction:column;align-items:center;min-height:calc(100vh - 60px)}
.sess-agent{text-align:center;margin-bottom:12px}
.sess-av{width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.1);margin-bottom:8px;transition:all 0.4s}
.sess-av.speaking{box-shadow:0 0 0 6px rgba(245,158,11,0.15),0 0 0 14px rgba(245,158,11,0.05);border-color:#f59e0b}
.sess-agent h2{font-size:17px;margin-bottom:1px}
.sess-agent .role{color:#f59e0b;font-size:11px}

.turn-ind{display:flex;align-items:center;gap:10px;padding:12px 28px;border-radius:24px;font-size:15px;font-weight:700;margin-bottom:10px;transition:all 0.3s;min-width:240px;justify-content:center;letter-spacing:0.3px}
.turn-ind.user-turn{background:rgba(34,197,94,0.15);color:#22c55e;border:2px solid rgba(34,197,94,0.35);box-shadow:0 0 20px rgba(34,197,94,0.1)}
.turn-ind.agent-turn{background:rgba(245,158,11,0.15);color:#f59e0b;border:2px solid rgba(245,158,11,0.35);box-shadow:0 0 20px rgba(245,158,11,0.1)}
.turn-ind.processing{background:rgba(148,163,184,0.08);color:#94a3b8;border:2px solid rgba(148,163,184,0.15)}
.turn-ind.connecting{background:rgba(245,158,11,0.1);color:#f59e0b;border:2px solid rgba(245,158,11,0.2)}
.turn-ind.warmup{background:rgba(99,102,241,0.12);color:#818cf8;border:2px solid rgba(99,102,241,0.25)}
.turn-ind.error{background:rgba(239,68,68,0.12);color:#ef4444;border:2px solid rgba(239,68,68,0.25)}
.t-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.t-dot.pulse{animation:pulse 1.4s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}

.timer{font-size:24px;font-weight:200;font-variant-numeric:tabular-nums;color:#475569;margin-bottom:10px}
.warmup-badge{font-size:10px;color:#818cf8;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;font-weight:600;display:none;background:rgba(99,102,241,0.1);padding:4px 12px;border-radius:10px}

/* TRANSCRIPT */
.tx-box{width:100%;background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:14px;flex:1;min-height:200px;max-height:400px;overflow-y:auto;margin-bottom:14px;scroll-behavior:smooth}
.tx-box:empty::before{content:'Conversation will appear here...';color:#475569;font-style:italic;font-size:13px}
.msg{margin-bottom:8px;padding:10px 14px;border-radius:10px;font-size:14px;line-height:1.5;max-width:88%;animation:fadeIn 0.2s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}
.msg.user{background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.1);margin-left:auto;text-align:right;border-bottom-right-radius:4px}
.msg.assistant{background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.08);margin-right:auto;border-bottom-left-radius:4px}
.msg .lbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px;opacity:0.5}
.msg .txt{word-wrap:break-word}
.sys-msg{text-align:center;color:#64748b;font-size:12px;padding:6px}

.controls{display:flex;gap:10px;align-items:center}
.mute-btn{width:42px;height:42px;border-radius:50%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#e2e8f0;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px}
.mute-btn.muted{background:rgba(239,68,68,0.15);border-color:#dc2626;color:#dc2626}
.end-btn{padding:11px 24px;background:#dc2626;color:white;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer}
.end-btn:hover{background:#b91c1c}
.kb-hint{font-size:11px;color:#475569;margin-left:8px}

/* STICKY NOTE */
.sticky-area{position:fixed;top:80px;right:24px;width:280px;display:flex;flex-direction:column;gap:12px;z-index:50;pointer-events:none}
@media(max-width:900px){.sticky-area{position:fixed;top:auto;bottom:80px;right:12px;left:12px;width:auto}}
.sticky{background:#1c1a0e;border:1px solid rgba(245,158,11,0.25);border-radius:12px;padding:16px;animation:slideIn 0.4s ease;pointer-events:auto;box-shadow:0 4px 24px rgba(0,0,0,0.4)}
@keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
.sticky-close{position:absolute;top:8px;right:10px;background:none;border:none;color:#64748b;cursor:pointer;font-size:14px}
.sticky-word{font-size:16px;font-weight:700;color:#f59e0b;margin-bottom:6px}
.sticky-def{font-size:13px;color:#c8d0dc;line-height:1.5}
.sticky-fade{animation:fadeOut 0.3s ease forwards}
@keyframes fadeOut{to{opacity:0;transform:translateX(30px)}}

/* â•â•â• REPORT â•â•â• */
.report-wrap{max-width:600px;width:100%;padding:36px 20px}
.rpt-loading{text-align:center;padding:60px 20px}
.rpt-spinner{display:inline-block;width:32px;height:32px;border:3px solid rgba(255,255,255,0.1);border-top-color:#f59e0b;border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:14px}
@keyframes spin{to{transform:rotate(360deg)}}

.rpt-hdr{text-align:center;margin-bottom:28px}
.rpt-hdr h1{font-size:22px;margin-bottom:4px}
.rpt-hdr .rpt-meta{font-size:13px;color:#94a3b8}

.score-ring-wrap{display:flex;justify-content:center;margin-bottom:24px}
.score-card{background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:24px 32px;text-align:center;display:flex;align-items:center;gap:24px}
@media(max-width:500px){.score-card{flex-direction:column;gap:16px}}
.ring-c{position:relative;width:100px;height:100px;flex-shrink:0}
.ring-c svg{transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:8}
.ring-fg{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1.5s ease}
.ring-lbl{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.ring-lvl{font-size:26px;font-weight:700;color:#f59e0b}
.ring-sub{font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:1px}
.score-dets{text-align:left}
.sd-row{margin-bottom:8px}
.sd-lbl{font-size:11px;color:#64748b;margin-bottom:3px}
.sd-bar-w{display:flex;align-items:center;gap:8px}
.sd-bar{height:6px;border-radius:3px;background:rgba(255,255,255,0.06);width:110px;overflow:hidden}
.sd-fill{height:100%;border-radius:3px;transition:width 1s ease}
.sd-v{font-size:12px;font-weight:600;min-width:28px}

.rpt-s{background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:20px;margin-bottom:14px}
.rpt-s h3{font-size:13px;color:#f59e0b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.rpt-s h3 .ico{font-size:16px}

.best-q{background:rgba(34,197,94,0.05);border-left:3px solid #22c55e;padding:12px 16px;border-radius:0 10px 10px 0;font-size:14px;font-style:italic;line-height:1.6;color:#c8d0dc;margin-bottom:8px}
.best-w{font-size:12px;color:#94a3b8;line-height:1.5}

.corr{margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.04)}.corr:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
.corr-b{font-size:13px;color:#ef4444;margin-bottom:3px;text-decoration:line-through;opacity:0.7}
.corr-a{font-size:13px;color:#22c55e;margin-bottom:3px;font-weight:500}
.corr-n{font-size:12px;color:#94a3b8;line-height:1.4}

.phrase-cards{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:500px){.phrase-cards{grid-template-columns:1fr}}
.pcard{background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.1);border-radius:10px;padding:14px;cursor:pointer;transition:all 0.3s;min-height:70px}
.pcard:hover{border-color:rgba(245,158,11,0.3)}
.pcard .pc-p{font-size:14px;font-weight:600;color:#f59e0b;margin-bottom:3px}
.pcard .pc-m{font-size:12px;color:#94a3b8;line-height:1.4}
.pcard .pc-ex{font-size:11px;color:#64748b;margin-top:4px;font-style:italic;display:none}
.pcard.open .pc-ex{display:block}

.conf-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media(max-width:450px){.conf-grid{grid-template-columns:1fr}}
.conf-st{text-align:center;padding:14px;background:rgba(255,255,255,0.02);border-radius:10px}
.conf-v{font-size:22px;font-weight:700;margin-bottom:2px}
.conf-l{font-size:11px;color:#64748b}

.reg-i{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.04)}.reg-i:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
.reg-said{font-size:13px;color:#94a3b8;margin-bottom:2px}
.reg-try{font-size:13px;color:#818cf8;font-weight:500;margin-bottom:2px}
.reg-ctx{font-size:12px;color:#64748b;line-height:1.4}

.pron-i{display:flex;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap}
.pron-w{font-size:14px;font-weight:600;min-width:90px}
.pron-ph{font-size:13px;color:#f59e0b;font-family:monospace}
.pron-tip{font-size:12px;color:#94a3b8}

.mission-box{background:rgba(245,158,11,0.05);border:1px solid rgba(245,158,11,0.15);border-radius:12px;padding:18px;text-align:center}
.m-title{font-size:12px;color:#f59e0b;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:600}
.m-text{font-size:15px;line-height:1.6;color:#e2e8f0}

.rpt-acts{display:flex;gap:10px;justify-content:center;margin-top:24px}
.rpt-acts button{padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none}
.rb-back{background:rgba(255,255,255,0.06);color:#e2e8f0;border:1px solid rgba(255,255,255,0.1)!important}
.rb-again{background:#f59e0b;color:#0a0e1a}
</style>
</head>
<body>

<div class="modal-overlay" id="keyModal">
<div class="modal">
<h3>OpenAI API Key</h3>
<p>Sent over HTTPS to mint a one-time session token, then discarded.</p>
<input type="password" id="apiKeyInput" placeholder="sk-..." autocomplete="off">
<div class="m-actions"><button class="btn-s" onclick="closeModal()">Cancel</button><button class="btn-p" onclick="saveKey()">Connect</button></div>
</div>
</div>

<div class="header">
<div class="logo">BASTION <span>VOICE</span></div>
<button class="hdr-btn" onclick="openModal()">API Key</button>
</div>

<!-- â•â•â• SCREEN 1: PICK AGENT â•â•â• -->
<div class="screen active" id="scrPick">
<div class="pick-wrap">
<h1>Practice Lab</h1>
<p class="sub">Choose your coach</p>
<div class="step-label">Select your conversation partner</div>
<div class="agents-row">
<div class="ag-card" onclick="pickAgent('elena')">
<div class="ag-top">
<img class="ag-av" src="https://randomuser.me/api/portraits/women/44.jpg" alt="">
<div class="ag-info"><h3>Elena Dubois</h3><div class="role">Professional Coach</div></div>
</div>
<div class="ag-desc">Warm, encouraging, great for building fluency and confidence. Ideal for regular practice.</div>
<span class="ag-badge badge-pro">Standard Sessions</span>
</div>
<div class="ag-card" onclick="pickAgent('marcus')">
<div class="ag-top">
<img class="ag-av" src="https://randomuser.me/api/portraits/men/32.jpg" alt="">
<div class="ag-info"><h3>Marcus Chen</h3><div class="role">Executive Coach</div></div>
</div>
<div class="ag-desc">Challenging, demanding, pushes you to perform. Advanced scenarios with difficulty control.</div>
<span class="ag-badge badge-exec">Premium Sessions</span>
</div>
</div>
</div>
</div>

<!-- â•â•â• SCREEN 2: CONFIG â•â•â• -->
<div class="screen" id="scrConfig">
<div class="config-wrap">
<div class="back-link" onclick="showScr('scrPick')">â† Choose different coach</div>
<div class="config-agent">
<img class="av" id="cfgAv" src="" alt="">
<div><h2 id="cfgName"></h2><div class="role" id="cfgRole"></div></div>
</div>

<div class="cfg-section">
<div class="cfg-label">What do you want to practice?</div>
<div class="goal-grid" id="goalGrid"></div>
</div>

<div class="cfg-section">
<div class="cfg-label">Scenario</div>
<div class="scenario-chips" id="scChips"></div>
<textarea class="custom-input" id="customSc" rows="2" placeholder="Or describe your own: 'I have a pricing call with my German client tomorrow...'"></textarea>
</div>

<div class="cfg-section" id="diffSection" style="display:none">
<div class="cfg-label">Difficulty</div>
<div class="diff-wrap">
<input type="range" class="diff-slider" min="0" max="100" value="50" id="diffSlider" oninput="updateDiff()">
<div class="diff-labels"><span>B1</span><span>B2</span><span>C1</span></div>
<div class="diff-current" id="diffDisplay">B2 â€” Intermediate</div>
</div>
</div>

<button class="go-btn" id="goBtn" disabled onclick="goToBriefing()">Choose a goal to continue</button>
</div>
</div>

<!-- â•â•â• SCREEN 3: BRIEFING â•â•â• -->
<div class="screen" id="scrBrief">
<div class="brief-wrap">
<img class="brief-av" id="brAv" src="" alt="">
<h2 id="brName"></h2>
<div class="role" id="brRole"></div>
<div class="brief-card">
<h3>How this works</h3>
<div class="rule"><div class="num">1</div><div>You'll start with a <strong>quick warm-up</strong> â€” casual chat to get comfortable.</div></div>
<div class="rule"><div class="num">2</div><div>Then the <strong>scenario begins</strong>. Treat it like a real conversation.</div></div>
<div class="rule"><div class="num">3</div><div>Your coach will <strong>model better phrasing</strong> naturally â€” listen for how they say things.</div></div>
<div class="rule"><div class="num">4</div><div>Ask <strong>"What does that mean?"</strong> anytime â€” you'll get a visual definition.</div></div>
<div class="rule"><div class="num">5</div><div>When done, you get a <strong>personal coaching report</strong> with specific feedback.</div></div>
</div>
<div class="brief-meta" id="brMeta"></div>
<button class="brief-btn" onclick="beginSession()">Start Conversation</button>
</div>
</div>

<!-- â•â•â• SCREEN 4: SESSION â•â•â• -->
<div class="screen" id="scrSession">
<div class="sess-outer">
<div class="sticky-area" id="stickyArea"></div>
<div class="sess-wrap">
<div class="sess-agent">
<img class="sess-av" id="sessAv" src="" alt="">
<h2 id="sessName"></h2>
<div class="role" id="sessRole"></div>
</div>
<div class="turn-ind connecting" id="turnInd"><div class="t-dot pulse"></div><span id="turnTxt">Connecting...</span></div>
<div class="warmup-badge" id="warmBadge">â˜• Warm-up</div>
<div class="timer" id="timer">00:00</div>
<div class="tx-box" id="transcript"></div>
<div class="controls">
<button class="mute-btn" id="muteBtn" onclick="toggleMute()" title="Mute (M)">ğŸ¤</button>
<button class="end-btn" onclick="endSession()">End Session</button>
<span class="kb-hint">M mute Â· Esc end</span>
</div>
</div>
</div>
</div>

<!-- â•â•â• SCREEN 5: REPORT â•â•â• -->
<div class="screen" id="scrReport">
<div class="report-wrap">
<div class="rpt-loading" id="rptLoading"><div class="rpt-spinner"></div><p style="color:#94a3b8">Generating your coaching report...</p></div>
<div id="rptContent" style="display:none"></div>
</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var AGENTS={
elena:{name:"Elena Dubois",first:"Elena",role:"Professional Coach",voice:"marin",model:"gpt-realtime-mini",
avatar:"https://randomuser.me/api/portraits/women/44.jpg",tier:"pro",
base:"You are Elena Dubois, a warm and encouraging professional Business English coach. You are having a real conversation with someone practicing their English.\n\nPersonality: Supportive, patient, positive. You celebrate good phrasing and gently model corrections.\n\nRules:\n- Keep responses 2-4 sentences, conversational\n- If they make errors, weave the correct form into YOUR next response naturally\n- Introduce 2-3 useful business phrases per conversation\n- React genuinely to their ideas\n- Be encouraging when they express things well\n- If they ask what a word or phrase means, explain it clearly and simply in 1-2 sentences\n\nYou are a coach having a real conversation. The learning happens through dialogue."},
marcus:{name:"Marcus Chen",first:"Marcus",role:"Executive Coach",voice:"ash",model:"gpt-realtime",
avatar:"https://randomuser.me/api/portraits/men/32.jpg",tier:"exec",
base:"You are Marcus Chen, a demanding executive Business English coach. You push people to perform at the highest level.\n\nPersonality: Direct, intellectually rigorous, high standards. You respect competence and challenge weakness.\n\nRules:\n- Keep responses 2-4 sentences, conversational not lecture\n- If they make errors, prominently model the correct form in your response\n- Challenge weak arguments, ask probing follow-ups\n- Introduce sophisticated business vocabulary and idioms\n- If they ask what a word or phrase means, give a precise, sharp definition in 1-2 sentences with a usage example\n- Adjust your complexity based on the difficulty level set\n\nYou are an executive coach having a real conversation. The learning is through the dialogue itself."}
};

var GOALS_PRO=[
{name:"Fluency & Confidence",icon:"ğŸ—£ï¸",prompt:"Focus on getting them to speak more, use longer sentences, reduce hesitation. Encourage elaboration."},
{name:"Grammar & Accuracy",icon:"ğŸ“",prompt:"Pay extra attention to grammar modeling. When they make errors, make sure your response prominently uses the correct form. Focus on tense, articles, prepositions."},
{name:"Vocabulary Building",icon:"ğŸ“š",prompt:"Deliberately use 4-5 useful business phrases. Use context clues so meaning is clear. Introduce phrases like 'circle back', 'take a deep dive', 'move the needle'."},
{name:"Small Talk & Rapport",icon:"â˜•",prompt:"Focus on casual professional conversation. Test rapport-building, finding common ground, appropriate humor, natural topic transitions."}
];

var GOALS_EXEC=[
{name:"Fluency & Confidence",icon:"ğŸ—£ï¸",prompt:"Push them to elaborate, structure complex arguments, minimize hesitation. Challenge incomplete thoughts."},
{name:"Grammar & Accuracy",icon:"ğŸ“",prompt:"Zero in on grammar. Prominently model corrections. Focus on tense consistency, articles, prepositions, conditionals, subjunctive."},
{name:"Vocabulary Building",icon:"ğŸ“š",prompt:"Use 5-6 sophisticated C1/C2 business phrases. Terms like 'leverage synergies', 'due diligence', 'value proposition', 'stakeholder alignment'. Push them to use advanced vocabulary."},
{name:"Pitch & Persuasion",icon:"ğŸ¯",prompt:"Test persuasive argumentation. Make them convince you. Push back hard on weak points. Evaluate structure, evidence, rhetorical devices."},
{name:"Negotiation Skills",icon:"ğŸ¤",prompt:"Create tough negotiation scenarios. Be firm, test creative problem-solving, diplomatic language, and ability to find win-win solutions under pressure."},
{name:"Small Talk & Rapport",icon:"â˜•",prompt:"Test sophisticated social fluency. Cultural references, humor, reading the room, transitioning from small talk to business seamlessly."}
];

var SCENARIOS=[
{name:"ğŸ’¼ Client Pitch",prompt:"Client pitch meeting. The user is presenting a proposal. Show interest but raise real objections."},
{name:"ğŸ¤ Negotiation",prompt:"Contract negotiation. Be firm on some points, flexible on others. Test creative solutions."},
{name:"ğŸ“Š Quarterly Review",prompt:"User presents quarterly results. Ask sharp questions, challenge weak areas, probe strategy."},
{name:"ğŸ¯ Job Interview",prompt:"Interview the user for a senior role. Mix behavioral, competency, and curveball questions."},
{name:"âš¡ Crisis Call",prompt:"Major product failure getting media attention. User must brief you â€” be urgent and demanding."},
{name:"ğŸŒ Free Chat",prompt:"Open professional conversation. Discuss trends, leadership, strategy. Be engaging. Let it flow."}
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var apiKey=null,pc=null,dc=null,stream=null,timerInt=null,startTime=null;
var selAgentId=null,selGoal=null,selSc=null,diffVal=50;
var isMuted=false,pendEl=null,pendRole=null;
var curAsstText="",curUserText="";
var userTurns=0,agentTurns=0,userWords=0,txLog=[];
var isAgentSpeaking=false,turnTs=[];
var warmupTimer=null;
var expectDef=false; // sticky note trigger

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(){document.getElementById("keyModal").classList.add("active");document.getElementById("apiKeyInput").focus()}
function closeModal(){document.getElementById("keyModal").classList.remove("active")}
function saveKey(){var k=document.getElementById("apiKeyInput").value.trim();if(k&&k.startsWith("sk-")){apiKey=k;closeModal()}else alert("Enter a valid key (starts with sk-)")}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScr(id){document.querySelectorAll(".screen").forEach(function(s){s.classList.remove("active")});document.getElementById(id).classList.add("active")}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN 1: PICK AGENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pickAgent(id){
selAgentId=id;selGoal=null;selSc=null;
document.querySelectorAll(".ag-card").forEach(function(c){c.classList.remove("sel")});
event.currentTarget.classList.add("sel");
var a=AGENTS[id];
document.getElementById("cfgAv").src=a.avatar;
document.getElementById("cfgName").textContent=a.name;
document.getElementById("cfgRole").textContent=a.role;
// Build goals
var goals=a.tier==="exec"?GOALS_EXEC:GOALS_PRO;
var gg=document.getElementById("goalGrid");gg.innerHTML="";
for(var i=0;i<goals.length;i++){
var d=document.createElement("div");d.className="goal-chip";d.setAttribute("data-idx",i);
d.innerHTML='<span class="g-icon">'+goals[i].icon+'</span>'+goals[i].name;
d.onclick=(function(idx){return function(){pickGoal(idx)}})(i);
gg.appendChild(d);
}
// Build scenarios
var sc=document.getElementById("scChips");sc.innerHTML="";
for(var i=0;i<SCENARIOS.length;i++){
var d=document.createElement("div");d.className="sc-chip";d.setAttribute("data-idx",i);
d.textContent=SCENARIOS[i].name;
d.onclick=(function(idx){return function(){pickScenario(idx)}})(i);
sc.appendChild(d);
}
document.getElementById("customSc").value="";
// Show difficulty only for exec
document.getElementById("diffSection").style.display=a.tier==="exec"?"block":"none";
updateGoBtn();
showScr("scrConfig");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN 2: CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pickGoal(i){
selGoal=i;
document.querySelectorAll(".goal-chip").forEach(function(c){c.classList.remove("sel")});
document.querySelector('.goal-chip[data-idx="'+i+'"]').classList.add("sel");
updateGoBtn();
}
function pickScenario(i){
selSc=i;
document.querySelectorAll(".sc-chip").forEach(function(c){c.classList.remove("sel")});
document.querySelector('.sc-chip[data-idx="'+i+'"]').classList.add("sel");
document.getElementById("customSc").value="";
updateGoBtn();
}
document.getElementById("customSc").addEventListener("input",function(){
if(this.value.trim()){selSc=-1;document.querySelectorAll(".sc-chip").forEach(function(c){c.classList.remove("sel")})}
updateGoBtn();
});

function updateDiff(){
diffVal=parseInt(document.getElementById("diffSlider").value);
var disp=document.getElementById("diffDisplay");
if(diffVal<33){disp.textContent="B1 â€” Pre-Intermediate";disp.style.color="#22c55e"}
else if(diffVal<66){disp.textContent="B2 â€” Intermediate";disp.style.color="#f59e0b"}
else{disp.textContent="C1 â€” Advanced";disp.style.color="#ef4444"}
}

function updateGoBtn(){
var btn=document.getElementById("goBtn");
var hasSc=selSc!==null||document.getElementById("customSc").value.trim();
if(selGoal!==null&&hasSc){btn.disabled=false;btn.textContent="Continue â†’"}
else if(selGoal!==null){btn.disabled=true;btn.textContent="Now pick a scenario"}
else{btn.disabled=true;btn.textContent="Choose a goal to continue"}
}

function getDiffPrompt(){
if(!AGENTS[selAgentId]||AGENTS[selAgentId].tier!=="exec")return"Speak naturally at a conversational pace. Use common business vocabulary.";
if(diffVal<33)return"DIFFICULTY B1: Speak simply and clearly. Short sentences. Avoid complex idioms. Moderate pace. If they struggle, rephrase. Use ONLY basic vocabulary from the Oxford 3000 word list.";
if(diffVal<66)return"DIFFICULTY B2: Speak naturally at a normal pace. Use common business idioms. Challenge them but don't overwhelm. Mix simple and moderately complex sentences.";
return"DIFFICULTY C1: Speak at full native speed. Use sophisticated vocabulary, complex subordinate clauses, nuanced idioms, and culturally specific references. Do NOT simplify. Use words like 'notwithstanding', 'pursuant to', 'juxtapose'. Challenge them intellectually.";
}

function getDiffLabel(){
if(!AGENTS[selAgentId]||AGENTS[selAgentId].tier!=="exec")return"Standard";
if(diffVal<33)return"B1 Pre-Intermediate";
if(diffVal<66)return"B2 Intermediate";
return"C1 Advanced";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN 3: BRIEFING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goToBriefing(){
var a=AGENTS[selAgentId];
document.getElementById("brAv").src=a.avatar;
document.getElementById("brName").textContent=a.name;
document.getElementById("brRole").textContent=a.role;
var goals=a.tier==="exec"?GOALS_EXEC:GOALS_PRO;
var scName=selSc>=0?SCENARIOS[selSc].name.replace(/^[^\s]+\s/,""):("Custom: "+document.getElementById("customSc").value.trim().substring(0,60));
document.getElementById("brMeta").innerHTML="<strong>Focus:</strong> "+goals[selGoal].name+"<br><strong>Scenario:</strong> "+scName+(a.tier==="exec"?"<br><strong>Difficulty:</strong> "+getDiffLabel():"");
showScr("scrBrief");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function beginSession(){
if(!apiKey){openModal();return}
var a=AGENTS[selAgentId];
var goals=a.tier==="exec"?GOALS_EXEC:GOALS_PRO;

var scenarioPrompt=selSc>=0?SCENARIOS[selSc].prompt:("Custom scenario from user: "+document.getElementById("customSc").value.trim()+". Simulate this realistically.");
var instructions=a.base+"\n\nSESSION GOAL:\n"+goals[selGoal].prompt+"\n\nSCENARIO:\n"+scenarioPrompt+"\n\n"+getDiffPrompt()+"\n\nWARM-UP: Start with 2-3 casual exchanges before the scenario. Ask how their week is, mention something light. Then transition naturally with 'So, shall we get into it?' or similar.\n\nIMPORTANT - VOCABULARY HELP: When the user asks what a word or phrase means (e.g. 'what does that mean?', 'what is X?', 'can you explain...'), give a clear, concise definition in 1-2 sentences. Start your explanation with the word or phrase followed by 'means' or 'refers to'.";

// UI setup
document.getElementById("sessAv").src=a.avatar;
document.getElementById("sessName").textContent=a.name;
document.getElementById("sessRole").textContent=a.role;
document.getElementById("transcript").innerHTML="";
document.getElementById("stickyArea").innerHTML="";
document.getElementById("warmBadge").style.display="inline-block";

userTurns=0;agentTurns=0;userWords=0;txLog=[];turnTs=[];
curAsstText="";curUserText="";pendEl=null;pendRole=null;isAgentSpeaking=false;expectDef=false;

setTurn("connecting","Connecting...");
showScr("scrSession");

try{
setTurn("connecting","Getting session token...");
var res=await fetch("/api/session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({voice:a.voice,instructions:instructions,model:a.model,apiKey:apiKey})});
var data=await res.json();
if(!res.ok){if(data.error==="NO_KEY"){setTurn("error","No API key");openModal();return}throw new Error(data.message||JSON.stringify(data.details)||"Session failed")}
var ek=data.clientSecret;if(!ek)throw new Error("No client secret. Check OpenAI billing/credits.");

setTurn("connecting","Requesting microphone...");
stream=await navigator.mediaDevices.getUserMedia({audio:true});

setTurn("connecting","Establishing connection...");
pc=new RTCPeerConnection();
var audioEl=document.createElement("audio");audioEl.autoplay=true;
pc.ontrack=function(e){audioEl.srcObject=e.streams[0]};
stream.getTracks().forEach(function(t){pc.addTrack(t,stream)});

dc=pc.createDataChannel("oai-events");
dc.addEventListener("open",function(){console.log("[DC] Data channel open")});
dc.addEventListener("message",handleEvent);

var offer=await pc.createOffer();await pc.setLocalDescription(offer);

var sdp=await fetch("https://api.openai.com/v1/realtime/calls",{method:"POST",body:offer.sdp,headers:{"Authorization":"Bearer "+ek,"Content-Type":"application/sdp"}});
if(!sdp.ok){var et=await sdp.text();throw new Error("WebRTC failed ("+sdp.status+"): "+et.substring(0,200))}
await pc.setRemoteDescription({type:"answer",sdp:await sdp.text()});

pc.onconnectionstatechange=function(){
var s=pc.connectionState;console.log("[PC] State:",s);
if(s==="connected"){setTurn("warmup","â˜• Warming up...");startTimer();warmupTimer=setTimeout(function(){document.getElementById("warmBadge").style.display="none"},60000)}
else if(s==="failed"||s==="disconnected"){setTurn("error","Connection lost")}
};
}catch(err){console.error("Session err:",err);setTurn("error",err.message)}
}

// â”€â”€â”€ EVENTS â”€â”€â”€
var gotAgentTranscript=false; // track if streaming transcript worked

function handleEvent(e){
var ev;try{ev=JSON.parse(e.data)}catch(x){return}
var a=AGENTS[selAgentId];

// Debug: log ALL non-audio-binary events
if(ev.type){console.log("[EV]",ev.type,ev.type.includes("transcript")?"ğŸ“":"",ev)}

switch(ev.type){

// â•â•â• TURN DETECTION (WebRTC-specific events) â•â•â•
case"output_audio_buffer.started":
// WebRTC-only: server started streaming audio to us
if(!isAgentSpeaking){isAgentSpeaking=true;turnTs.push({role:"agent",ms:Date.now()})}
setTurn("agent-turn",a.first+" is speaking...");
document.getElementById("sessAv").classList.add("speaking");
break;

case"output_audio_buffer.stopped":
// WebRTC-only: server done streaming audio
document.getElementById("sessAv").classList.remove("speaking");
isAgentSpeaking=false;
setTurn("user-turn","Your turn â€” speak now");
break;

// â•â•â• AGENT TRANSCRIPT (streaming) â•â•â•
case"response.audio_transcript.delta":
gotAgentTranscript=true;
curAsstText+=(ev.delta||"");
upsertMsg("assistant",curAsstText,a.first);
break;

case"response.audio_transcript.done":
gotAgentTranscript=true;
var finalText=ev.transcript||curAsstText;
if(finalText){
commitMsg("assistant",finalText,a.first);
txLog.push({role:"assistant",text:finalText});
agentTurns++;
if(expectDef){showSticky(finalText);expectDef=false}
}
curAsstText="";
break;

// â•â•â• FALLBACK: extract transcript from response.done â•â•â•
case"response.done":
if(!gotAgentTranscript&&ev.response&&ev.response.output){
// Streaming transcript didn't work, extract from response
for(var i=0;i<ev.response.output.length;i++){
var item=ev.response.output[i];
if(item.content){
for(var j=0;j<item.content.length;j++){
var c=item.content[j];
if(c.transcript&&c.transcript.length>0){
commitMsg("assistant",c.transcript,a.first);
txLog.push({role:"assistant",text:c.transcript});
agentTurns++;
if(expectDef){showSticky(c.transcript);expectDef=false}
}
}
}
}
}
gotAgentTranscript=false; // reset for next response
break;

// â•â•â• FALLBACK 2: conversation.item.done â•â•â•
case"conversation.item.done":
// Another fallback path for agent transcript
if(ev.item&&ev.item.role==="assistant"&&ev.item.content){
for(var k=0;k<ev.item.content.length;k++){
var ct=ev.item.content[k];
if(ct.transcript&&ct.transcript.length>0&&!gotAgentTranscript){
// Only use if we didn't already get it from streaming
var isDup=txLog.length>0&&txLog[txLog.length-1].text===ct.transcript;
if(!isDup){
commitMsg("assistant",ct.transcript,a.first);
txLog.push({role:"assistant",text:ct.transcript});
agentTurns++;
if(expectDef){showSticky(ct.transcript);expectDef=false}
}
}
}
}
break;

// â•â•â• USER TRANSCRIPT â•â•â•
case"conversation.item.input_audio_transcription.delta":
curUserText+=(ev.delta||"");
upsertMsg("user",curUserText,"You");
break;

case"conversation.item.input_audio_transcription.completed":
var t=ev.transcript||curUserText;
if(t){
commitMsg("user",t,"You");
txLog.push({role:"user",text:t});
userTurns++;
userWords+=t.split(/\s+/).filter(function(w){return w.length>0}).length;
// Check if user is asking for a definition
var lower=t.toLowerCase();
if(lower.includes("what does")||lower.includes("what is")||lower.includes("what do you mean")||lower.includes("can you explain")||lower.includes("meaning of")||lower.includes("what's that mean")||lower.includes("i don't understand")||lower.includes("define")){
expectDef=true;
}
}
curUserText="";
break;

// â•â•â• USER SPEAKING DETECTION â•â•â•
case"input_audio_buffer.speech_started":
setTurn("user-turn","Listening...");
turnTs.push({role:"user_start",ms:Date.now()});
break;

case"input_audio_buffer.speech_stopped":
document.getElementById("sessAv").classList.remove("speaking");
setTurn("processing","Processing...");
break;

// â•â•â• FALLBACK turn detection if WebRTC events don't fire â•â•â•
case"response.created":
if(!isAgentSpeaking){isAgentSpeaking=true;turnTs.push({role:"agent",ms:Date.now()})}
setTurn("agent-turn",a.first+" is speaking...");
document.getElementById("sessAv").classList.add("speaking");
break;

case"error":
console.error("RT error:",ev.error);
addSys("Error: "+((ev.error&&ev.error.message)||JSON.stringify(ev.error)||"Unknown"));
break;
}
}

function setTurn(cls,txt){document.getElementById("turnInd").className="turn-ind "+cls;document.getElementById("turnTxt").textContent=txt}

// â”€â”€â”€ TRANSCRIPT â”€â”€â”€
function upsertMsg(role,text,label){
var box=document.getElementById("transcript");
if(pendEl&&pendRole===role){pendEl.querySelector(".txt").textContent=text}
else{
if(pendEl&&pendRole){/* finalize previous */}
pendEl=document.createElement("div");pendEl.className="msg "+role;
pendEl.innerHTML='<div class="lbl">'+esc(label)+'</div><div class="txt">'+esc(text)+'</div>';
pendRole=role;box.appendChild(pendEl);
}
box.scrollTop=box.scrollHeight;
}
function commitMsg(role,text,label){
if(pendEl&&pendRole===role){pendEl.querySelector(".txt").textContent=text;pendEl=null;pendRole=null}
else{var box=document.getElementById("transcript");var el=document.createElement("div");el.className="msg "+role;el.innerHTML='<div class="lbl">'+esc(label)+'</div><div class="txt">'+esc(text)+'</div>';box.appendChild(el);box.scrollTop=box.scrollHeight;pendEl=null;pendRole=null}
}
function addSys(t){var box=document.getElementById("transcript");var el=document.createElement("div");el.className="sys-msg";el.textContent=t;box.appendChild(el)}

// â”€â”€â”€ STICKY NOTE â”€â”€â”€
function showSticky(text){
var area=document.getElementById("stickyArea");
// Try to extract word + definition
var word="",def=text;
var patterns=[/^["']?([^"']+?)["']?\s+means?\s+/i,/^["']?([^"']+?)["']?\s+refers?\s+to\s+/i,/^["']?([^"']+?)["']?\s+is\s+(when|a|an|the)\s+/i];
for(var i=0;i<patterns.length;i++){var m=text.match(patterns[i]);if(m){word=m[1];def=text;break}}
if(!word){var sentences=text.split(/[.!?]/);if(sentences.length>0)def=text}

var note=document.createElement("div");note.className="sticky";
note.innerHTML=(word?'<div class="sticky-word">'+esc(word)+'</div>':'')+'<div class="sticky-def">'+esc(def)+'</div><button class="sticky-close" onclick="dismissSticky(this)">âœ•</button>';
area.appendChild(note);
// Auto-dismiss after 15s
setTimeout(function(){if(note.parentNode){note.classList.add("sticky-fade");setTimeout(function(){if(note.parentNode)note.parentNode.removeChild(note)},300)}},15000);
}
function dismissSticky(btn){var s=btn.parentNode;s.classList.add("sticky-fade");setTimeout(function(){if(s.parentNode)s.parentNode.removeChild(s)},300)}

// â”€â”€â”€ TIMER â”€â”€â”€
function startTimer(){startTime=Date.now();timerInt=setInterval(function(){var s=Math.floor((Date.now()-startTime)/1000);document.getElementById("timer").textContent=String(Math.floor(s/60)).padStart(2,"0")+":"+String(s%60).padStart(2,"0")},1000)}

function toggleMute(){
isMuted=!isMuted;
if(stream)stream.getAudioTracks().forEach(function(t){t.enabled=!isMuted});
document.getElementById("muteBtn").textContent=isMuted?"ğŸ”‡":"ğŸ¤";
document.getElementById("muteBtn").classList.toggle("muted",isMuted);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END + REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function endSession(){
var dur="00:00",durSec=0;
if(startTime){durSec=Math.floor((Date.now()-startTime)/1000);dur=String(Math.floor(durSec/60)).padStart(2,"0")+":"+String(durSec%60).padStart(2,"0")}
if(timerInt)clearInterval(timerInt);if(warmupTimer)clearTimeout(warmupTimer);
if(dc)try{dc.close()}catch(x){}if(pc)try{pc.close()}catch(x){}
if(stream)stream.getTracks().forEach(function(t){t.stop()});
pc=null;dc=null;stream=null;isMuted=false;isAgentSpeaking=false;pendEl=null;pendRole=null;curAsstText="";curUserText="";
document.getElementById("muteBtn").classList.remove("muted");document.getElementById("muteBtn").textContent="ğŸ¤";
document.getElementById("sessAv").classList.remove("speaking");
if(txLog.length>2)genReport(dur,durSec);else showScr("scrPick");
}

async function genReport(dur,durSec){
showScr("scrReport");
document.getElementById("rptLoading").style.display="block";
document.getElementById("rptContent").style.display="none";

var a=AGENTS[selAgentId];
var goals=a.tier==="exec"?GOALS_EXEC:GOALS_PRO;
var txText=txLog.map(function(m){return(m.role==="user"?"USER":"AGENT")+": "+m.text}).join("\n");

var avgWpt=userTurns>0?Math.round(userWords/userTurns):0;
var rts=[];for(var i=1;i<turnTs.length;i++){if(turnTs[i].role==="user_start"){for(var j=i-1;j>=0;j--){if(turnTs[j].role==="agent"){rts.push(turnTs[i].ms-turnTs[j].ms);break}}}}
var avgRt=rts.length>0?((rts.reduce(function(a,b){return a+b},0)/rts.length)/1000).toFixed(1)+"s":"N/A";

var prompt='You are an expert Business English coach. Analyze this conversation. Return ONLY raw JSON (no markdown backticks).\n\nSession: Goal='+goals[selGoal].name+', Scenario='+(selSc>=0?SCENARIOS[selSc].name.replace(/^[^\s]+\s/,""):"Custom")+', Difficulty='+getDiffLabel()+', Duration='+dur+', User turns='+userTurns+', Words='+userWords+', Avg words/turn='+avgWpt+', Avg response time='+avgRt+'\n\nTRANSCRIPT:\n'+txText+'\n\nReturn:\n{"cefrLevel":"B1/B2/C1/C2","cefrScore":0-100,"subScores":{"grammar":0-100,"vocabulary":0-100,"fluency":0-100,"taskAchievement":0-100},"bestMoment":{"quote":"exact user quote","why":"why good"},"corrections":[{"said":"user said","better":"corrected","note":"explanation"}],"registerSuggestions":[{"said":"too casual","try":"professional version","context":"when to use"}],"phrasesToSteal":[{"phrase":"from agent","meaning":"definition","example":"in a sentence"}],"pronunciationNotes":[{"word":"tricky word","phonetic":"how to say it","tip":"common mistake"}],"confidenceAssessment":"1-2 sentences","mission":"one concrete thing to practice"}\n\nProvide 2-3 corrections, 2 register suggestions, 4-5 phrases, 2-3 pronunciation notes. Use their ACTUAL words. Be encouraging but honest.';

try{
var res=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Authorization":"Bearer "+apiKey,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"user",content:prompt}],max_tokens:1500,temperature:0.7})});
var data=await res.json();
var raw=data.choices[0].message.content.replace(/```json\s*/g,"").replace(/```\s*/g,"").trim();
var rpt=JSON.parse(raw);
renderReport(rpt,dur,avgWpt,avgRt);
}catch(err){
console.error("Report err:",err);
document.getElementById("rptContent").innerHTML='<div class="rpt-s"><p style="color:#ef4444">Error: '+esc(err.message)+'</p></div>'+rptActsHtml();
document.getElementById("rptContent").style.display="block";
document.getElementById("rptLoading").style.display="none";
}
}

function renderReport(r,dur,avgWpt,avgRt){
var a=AGENTS[selAgentId],goals=a.tier==="exec"?GOALS_EXEC:GOALS_PRO;
function sc(v){return v>=75?"#22c55e":v>=50?"#f59e0b":"#ef4444"}
var lvls={A2:20,B1:40,B2:60,C1:80,C2:95};
var ringPct=Math.min(95,Math.max(5,(lvls[r.cefrLevel]||50)-15+r.cefrScore*0.3));
var circ=2*Math.PI*44,off=circ*(1-ringPct/100);

var h='<div class="rpt-hdr"><h1>Session Report</h1><div class="rpt-meta">'+dur+' Â· '+a.name+' Â· '+goals[selGoal].name+(a.tier==="exec"?' Â· '+getDiffLabel():'')+'</div></div>';

// Score ring
h+='<div class="score-ring-wrap"><div class="score-card"><div class="ring-c"><svg width="100" height="100" viewBox="0 0 100 100"><circle class="ring-bg" cx="50" cy="50" r="44"/><circle class="ring-fg" cx="50" cy="50" r="44" style="stroke:'+sc(ringPct)+';stroke-dasharray:'+circ+';stroke-dashoffset:'+off+'"/></svg><div class="ring-lbl"><div class="ring-lvl">'+r.cefrLevel+'</div><div class="ring-sub">Level</div></div></div><div class="score-dets">';
[["Grammar",r.subScores.grammar],["Vocabulary",r.subScores.vocabulary],["Fluency",r.subScores.fluency],["Task",r.subScores.taskAchievement]].forEach(function(s){
h+='<div class="sd-row"><div class="sd-lbl">'+s[0]+'</div><div class="sd-bar-w"><div class="sd-bar"><div class="sd-fill" style="width:'+s[1]+'%;background:'+sc(s[1])+'"></div></div><div class="sd-v" style="color:'+sc(s[1])+'">'+s[1]+'</div></div></div>';
});
h+='</div></div></div>';

// Confidence
h+='<div class="rpt-s"><h3><span class="ico">ğŸ’ª</span>Confidence</h3><div class="conf-grid"><div class="conf-st"><div class="conf-v">'+avgWpt+'</div><div class="conf-l">Words / turn</div></div><div class="conf-st"><div class="conf-v">'+avgRt+'</div><div class="conf-l">Response time</div></div><div class="conf-st"><div class="conf-v">'+userTurns+'</div><div class="conf-l">Your turns</div></div></div><p style="font-size:13px;color:#94a3b8;margin-top:10px;line-height:1.5">'+esc(r.confidenceAssessment)+'</p></div>';

// Best moment
h+='<div class="rpt-s"><h3><span class="ico">â­</span>Your Best Moment</h3><div class="best-q">"'+esc(r.bestMoment.quote)+'"</div><div class="best-w">'+esc(r.bestMoment.why)+'</div></div>';

// Corrections
if(r.corrections&&r.corrections.length){h+='<div class="rpt-s"><h3><span class="ico">ğŸ”§</span>Try This Instead</h3>';r.corrections.forEach(function(c){h+='<div class="corr"><div class="corr-b">âœ— "'+esc(c.said)+'"</div><div class="corr-a">âœ“ "'+esc(c.better)+'"</div><div class="corr-n">'+esc(c.note)+'</div></div>'});h+='</div>'}

// Register
if(r.registerSuggestions&&r.registerSuggestions.length){h+='<div class="rpt-s"><h3><span class="ico">ğŸ©</span>Level Up Your Register</h3>';r.registerSuggestions.forEach(function(g){h+='<div class="reg-i"><div class="reg-said">You said: "'+esc(g.said)+'"</div><div class="reg-try">Try: "'+esc(g["try"])+'"</div><div class="reg-ctx">'+esc(g.context)+'</div></div>'});h+='</div>'}

// Phrases
if(r.phrasesToSteal&&r.phrasesToSteal.length){h+='<div class="rpt-s"><h3><span class="ico">ğŸ’</span>Phrases to Steal</h3><div class="phrase-cards">';r.phrasesToSteal.forEach(function(p){h+='<div class="pcard" onclick="this.classList.toggle(\'open\')"><div class="pc-p">'+esc(p.phrase)+'</div><div class="pc-m">'+esc(p.meaning)+'</div><div class="pc-ex">"'+esc(p.example)+'"</div></div>'});h+='</div></div>'}

// Pronunciation
if(r.pronunciationNotes&&r.pronunciationNotes.length){h+='<div class="rpt-s"><h3><span class="ico">ğŸ—£ï¸</span>Pronunciation</h3>';r.pronunciationNotes.forEach(function(p){h+='<div class="pron-i"><div class="pron-w">'+esc(p.word)+'</div><div class="pron-ph">'+esc(p.phonetic)+'</div><div class="pron-tip">'+esc(p.tip)+'</div></div>'});h+='</div>'}

// Mission
h+='<div class="rpt-s"><div class="mission-box"><div class="m-title">ğŸ¯ Your Mission</div><div class="m-text">'+esc(r.mission)+'</div></div></div>';
h+=rptActsHtml();

document.getElementById("rptContent").innerHTML=h;
document.getElementById("rptContent").style.display="block";
document.getElementById("rptLoading").style.display="none";
}

function rptActsHtml(){return'<div class="rpt-acts"><button class="rb-back" onclick="showScr(\'scrPick\')">New Session</button><button class="rb-again" onclick="retrySession()">Practice Again</button></div>'}
function retrySession(){showScr("scrBrief");setTimeout(beginSession,100)}

function esc(s){return s?String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}

// Keyboard
document.addEventListener("keydown",function(e){
if(e.key==="Escape"&&document.getElementById("scrSession").classList.contains("active"))endSession();
if(e.key==="m"&&document.getElementById("scrSession").classList.contains("active")&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName))toggleMute();
});
</script>
</body>
</html>
