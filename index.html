<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bastion Voice</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0e1a;color:#e2e8f0;min-height:100vh;overflow-x:hidden}

.header{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;border-bottom:1px solid rgba(255,255,255,0.06)}
.logo{font-size:17px;font-weight:700;letter-spacing:1px}.logo span{color:#f59e0b}
.hdr-btn{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#94a3b8;padding:7px 14px;border-radius:8px;cursor:pointer;font-size:12px}
.hdr-btn:hover{background:rgba(255,255,255,0.1);color:#e2e8f0}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:#1a1f2e;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px;max-width:440px;width:90%}
.modal h3{font-size:17px;margin-bottom:6px}
.modal p{font-size:13px;color:#94a3b8;margin-bottom:18px;line-height:1.5}
.modal input{width:100%;padding:11px 14px;background:#0a0e1a;border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#e2e8f0;font-size:13px;font-family:monospace;margin-bottom:14px}
.modal input:focus{outline:none;border-color:#f59e0b}
.m-actions{display:flex;gap:10px}
.btn-p{flex:1;padding:11px;background:#f59e0b;color:#0a0e1a;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer}
.btn-s{padding:11px 18px;background:transparent;color:#94a3b8;border:1px solid rgba(255,255,255,0.1);border-radius:8px;font-size:13px;cursor:pointer}

/* SCREENS */
.screen{display:none}.screen.active{display:flex;flex-direction:column;align-items:center}

/* ‚îÄ‚îÄ‚îÄ MODE SELECT ‚îÄ‚îÄ‚îÄ */
.mode-wrap{max-width:660px;width:100%;padding:40px 20px}
.mode-wrap h1{font-size:24px;font-weight:700;text-align:center;margin-bottom:4px}
.mode-wrap .sub{color:#94a3b8;font-size:14px;text-align:center;margin-bottom:32px;line-height:1.5}
.mode-cards{display:flex;flex-direction:column;gap:12px}
.mc{background:#111827;border:2px solid rgba(255,255,255,0.06);border-radius:14px;padding:22px 24px;cursor:pointer;transition:all 0.25s;display:flex;gap:18px;align-items:flex-start}
.mc:hover{border-color:rgba(245,158,11,0.3);background:#131a2b}
.mc .mc-icon{font-size:28px;flex-shrink:0;margin-top:2px}
.mc .mc-info h3{font-size:16px;margin-bottom:3px}
.mc .mc-info .mc-d{font-size:13px;color:#94a3b8;line-height:1.5}
.mc .mc-info .mc-tag{display:inline-block;font-size:10px;font-weight:600;padding:3px 8px;border-radius:6px;margin-top:6px;background:rgba(245,158,11,0.1);color:#f59e0b;border:1px solid rgba(245,158,11,0.15)}

/* ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ */
.config-wrap{max-width:580px;width:100%;padding:36px 20px}
.back-link{color:#94a3b8;font-size:13px;cursor:pointer;margin-bottom:20px;display:inline-flex;align-items:center;gap:6px}
.back-link:hover{color:#e2e8f0}
.cfg-mode-hdr{display:flex;align-items:center;gap:14px;margin-bottom:24px;padding-bottom:18px;border-bottom:1px solid rgba(255,255,255,0.06)}
.cfg-mode-hdr .mi{font-size:32px}
.cfg-mode-hdr h2{font-size:18px}
.cfg-mode-hdr .role{color:#f59e0b;font-size:12px}

.cfg-section{margin-bottom:22px}
.cfg-label{font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:1.2px;font-weight:600;margin-bottom:10px}

.scenario-chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.sc-chip{background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:9px 14px;cursor:pointer;transition:all 0.2s;font-size:12px;font-weight:500}
.sc-chip:hover{border-color:rgba(245,158,11,0.3)}
.sc-chip.sel{border-color:#f59e0b;background:rgba(245,158,11,0.04)}
.custom-input{width:100%;padding:11px 14px;background:#111827;border:1px solid rgba(255,255,255,0.08);border-radius:10px;color:#e2e8f0;font-size:13px;font-family:inherit;resize:none;line-height:1.5}
.custom-input:focus{outline:none;border-color:#f59e0b}
.custom-input::placeholder{color:#475569}

/* DIFFICULTY SLIDER */
.diff-slider{-webkit-appearance:none;width:100%;height:6px;border-radius:3px;background:linear-gradient(to right,#22c55e 0%,#22c55e 33%,#f59e0b 33%,#f59e0b 66%,#ef4444 66%,#ef4444 100%);outline:none;cursor:pointer;margin:8px 0}
.diff-slider::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:#fff;border:3px solid #0a0e1a;box-shadow:0 0 0 2px rgba(255,255,255,0.3),0 2px 8px rgba(0,0,0,0.3);cursor:pointer;transition:transform 0.15s}
.diff-slider::-webkit-slider-thumb:hover{transform:scale(1.15)}
.diff-slider::-moz-range-thumb{width:24px;height:24px;border-radius:50%;background:#fff;border:3px solid #0a0e1a;box-shadow:0 0 0 2px rgba(255,255,255,0.3);cursor:pointer}
.diff-labels{display:flex;justify-content:space-between;font-size:11px;color:#64748b;margin-top:2px}
.diff-current{text-align:center;font-size:15px;font-weight:700;margin-top:8px;transition:color 0.3s}

/* Timer select */
.timer-opts{display:flex;gap:10px}
.t-opt{flex:1;padding:14px;background:#111827;border:2px solid rgba(255,255,255,0.06);border-radius:10px;cursor:pointer;text-align:center;transition:all 0.2s}
.t-opt:hover{border-color:rgba(245,158,11,0.3)}
.t-opt.sel{border-color:#f59e0b;background:rgba(245,158,11,0.04)}
.t-opt .tv{font-size:20px;font-weight:700;color:#f59e0b}
.t-opt .tl{font-size:11px;color:#64748b;margin-top:2px}

.go-btn{display:block;width:100%;padding:15px;background:#f59e0b;color:#0a0e1a;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:8px}
.go-btn:hover{background:#d97706}
.go-btn:disabled{opacity:0.25;cursor:not-allowed}

/* ‚îÄ‚îÄ‚îÄ BRIEFING ‚îÄ‚îÄ‚îÄ */
.brief-wrap{max-width:520px;width:100%;padding:40px 20px;text-align:center}
.brief-icon{font-size:48px;margin-bottom:14px}
.brief-wrap h2{font-size:20px;margin-bottom:2px}
.brief-wrap .role{color:#f59e0b;font-size:12px;margin-bottom:24px}
.brief-card{background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:22px;text-align:left;margin-bottom:20px}
.brief-card h3{font-size:13px;color:#f59e0b;margin-bottom:14px;text-transform:uppercase;letter-spacing:0.5px}
.rule{display:flex;gap:10px;margin-bottom:10px;font-size:13px;line-height:1.5;color:#c8d0dc}
.rule .num{width:22px;height:22px;border-radius:50%;background:rgba(245,158,11,0.12);color:#f59e0b;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:1px}
.brief-meta{font-size:13px;color:#94a3b8;line-height:1.6;margin-bottom:24px;padding:16px;background:rgba(255,255,255,0.02);border-radius:10px;text-align:left}
.brief-meta strong{color:#e2e8f0}
.brief-btn{padding:14px 40px;background:#f59e0b;color:#0a0e1a;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer}
.brief-btn:hover{background:#d97706}

/* ‚ïê‚ïê‚ïê SESSION ‚ïê‚ïê‚ïê */
.sess-outer{width:100%;position:relative}
.sess-wrap{max-width:580px;width:100%;padding:24px 20px;margin:0 auto;display:flex;flex-direction:column;align-items:center;min-height:calc(100vh - 60px)}

.turn-ind{display:flex;align-items:center;gap:10px;padding:12px 28px;border-radius:24px;font-size:15px;font-weight:700;margin-bottom:12px;transition:all 0.3s;min-width:240px;justify-content:center;letter-spacing:0.3px}
.turn-ind.user-turn{background:rgba(34,197,94,0.15);color:#22c55e;border:2px solid rgba(34,197,94,0.35);box-shadow:0 0 20px rgba(34,197,94,0.1)}
.turn-ind.agent-turn{background:rgba(245,158,11,0.15);color:#f59e0b;border:2px solid rgba(245,158,11,0.35);box-shadow:0 0 20px rgba(245,158,11,0.1)}
.turn-ind.processing{background:rgba(148,163,184,0.08);color:#94a3b8;border:2px solid rgba(148,163,184,0.15)}
.turn-ind.connecting{background:rgba(245,158,11,0.1);color:#f59e0b;border:2px solid rgba(245,158,11,0.2)}
.turn-ind.presenting{background:rgba(99,102,241,0.15);color:#818cf8;border:2px solid rgba(99,102,241,0.3);box-shadow:0 0 20px rgba(99,102,241,0.1)}
.turn-ind.error{background:rgba(239,68,68,0.12);color:#ef4444;border:2px solid rgba(239,68,68,0.25)}
.t-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.t-dot.pulse{animation:pulse 1.4s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}

.timer-big{font-size:48px;font-weight:200;font-variant-numeric:tabular-nums;color:#475569;margin-bottom:6px;transition:color 0.5s}
.timer-big.urgent{color:#ef4444;animation:pulse 1s infinite}
.timer-small{font-size:20px}

/* Presentation progress bar */
.pres-bar-wrap{width:100%;max-width:400px;margin-bottom:16px;display:none}
.pres-bar{height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden}
.pres-fill{height:100%;background:#818cf8;border-radius:2px;transition:width 1s linear}
.pres-label{text-align:center;font-size:11px;color:#64748b;margin-top:4px}

/* TRANSCRIPT */
.tx-box{width:100%;background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:14px;flex:1;min-height:200px;max-height:400px;overflow-y:auto;margin-bottom:14px;scroll-behavior:smooth}
.tx-box:empty::before{content:'Conversation will appear here...';color:#475569;font-style:italic;font-size:13px}
.msg{margin-bottom:8px;padding:10px 14px;border-radius:10px;font-size:14px;line-height:1.5;max-width:88%;animation:fadeIn 0.2s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}
.msg.user{background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.1);margin-left:auto;text-align:right;border-bottom-right-radius:4px}
.msg.assistant{background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.08);margin-right:auto;border-bottom-left-radius:4px}
.msg .lbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px;opacity:0.5}
.msg .txt{word-wrap:break-word}
.sys-msg{text-align:center;color:#64748b;font-size:12px;padding:6px}

/* Writing mode text area */
.writing-area{width:100%;margin-bottom:14px}
.writing-area textarea{width:100%;min-height:180px;padding:16px;background:#111827;border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:#e2e8f0;font-size:14px;font-family:inherit;resize:vertical;line-height:1.6}
.writing-area textarea:focus{outline:none;border-color:#f59e0b}
.writing-area textarea::placeholder{color:#475569}
.writing-submit{padding:12px 28px;background:#f59e0b;color:#0a0e1a;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;margin-top:8px}
.writing-submit:hover{background:#d97706}
.writing-submit:disabled{opacity:0.3;cursor:not-allowed}
.writing-followup{width:100%;display:flex;gap:8px;margin-bottom:14px}
.writing-followup input{flex:1;padding:11px 14px;background:#111827;border:1px solid rgba(255,255,255,0.08);border-radius:10px;color:#e2e8f0;font-size:13px;font-family:inherit}
.writing-followup input:focus{outline:none;border-color:#f59e0b}
.writing-followup button{padding:11px 18px;background:#f59e0b;color:#0a0e1a;border:none;border-radius:10px;font-weight:600;font-size:13px;cursor:pointer}

.controls{display:flex;gap:10px;align-items:center}
.mute-btn{width:42px;height:42px;border-radius:50%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#e2e8f0;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px}
.mute-btn.muted{background:rgba(239,68,68,0.15);border-color:#dc2626;color:#dc2626}
.end-btn{padding:11px 24px;background:#dc2626;color:white;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer}
.end-btn:hover{background:#b91c1c}
.kb-hint{font-size:11px;color:#475569;margin-left:8px}

/* STICKY NOTE */
.sticky-area{position:fixed;top:80px;right:24px;width:280px;display:flex;flex-direction:column;gap:12px;z-index:50;pointer-events:none}
@media(max-width:900px){.sticky-area{position:fixed;top:auto;bottom:80px;right:12px;left:12px;width:auto}}
.sticky{background:#1c1a0e;border:1px solid rgba(245,158,11,0.25);border-radius:12px;padding:16px;animation:slideIn 0.4s ease;pointer-events:auto;box-shadow:0 4px 24px rgba(0,0,0,0.4)}
@keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
.sticky-close{position:absolute;top:8px;right:10px;background:none;border:none;color:#64748b;cursor:pointer;font-size:14px}
.sticky-word{font-size:16px;font-weight:700;color:#f59e0b;margin-bottom:6px}
.sticky-def{font-size:13px;color:#c8d0dc;line-height:1.5}
.sticky-fade{animation:fadeOut 0.3s ease forwards}
@keyframes fadeOut{to{opacity:0;transform:translateX(30px)}}

/* ‚ïê‚ïê‚ïê REPORT ‚ïê‚ïê‚ïê */
.report-wrap{max-width:600px;width:100%;padding:36px 20px}
.rpt-loading{text-align:center;padding:60px 20px}
.rpt-spinner{display:inline-block;width:32px;height:32px;border:3px solid rgba(255,255,255,0.1);border-top-color:#f59e0b;border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:14px}
@keyframes spin{to{transform:rotate(360deg)}}

.rpt-hdr{text-align:center;margin-bottom:28px}
.rpt-hdr h1{font-size:22px;margin-bottom:4px}
.rpt-hdr .rpt-meta{font-size:13px;color:#94a3b8}

.score-ring-wrap{display:flex;justify-content:center;margin-bottom:24px}
.score-card{background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:24px 32px;text-align:center;display:flex;align-items:center;gap:24px}
@media(max-width:500px){.score-card{flex-direction:column;gap:16px}}
.ring-c{position:relative;width:100px;height:100px;flex-shrink:0}
.ring-c svg{transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:8}
.ring-fg{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1.5s ease}
.ring-lbl{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.ring-lvl{font-size:26px;font-weight:700;color:#f59e0b}
.ring-sub{font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:1px}
.score-dets{text-align:left}
.sd-row{margin-bottom:8px}
.sd-lbl{font-size:11px;color:#64748b;margin-bottom:3px}
.sd-bar-w{display:flex;align-items:center;gap:8px}
.sd-bar{height:6px;border-radius:3px;background:rgba(255,255,255,0.06);width:110px;overflow:hidden}
.sd-fill{height:100%;border-radius:3px;transition:width 1s ease}
.sd-v{font-size:12px;font-weight:600;min-width:28px}

.rpt-s{background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:20px;margin-bottom:14px}
.rpt-s h3{font-size:13px;color:#f59e0b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.rpt-s h3 .ico{font-size:16px}

.best-q{background:rgba(34,197,94,0.05);border-left:3px solid #22c55e;padding:12px 16px;border-radius:0 10px 10px 0;font-size:14px;font-style:italic;line-height:1.6;color:#c8d0dc;margin-bottom:8px}
.best-w{font-size:12px;color:#94a3b8;line-height:1.5}

.corr{margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.04)}.corr:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
.corr-b{font-size:13px;color:#ef4444;margin-bottom:3px;text-decoration:line-through;opacity:0.7}
.corr-a{font-size:13px;color:#22c55e;margin-bottom:3px;font-weight:500}
.corr-n{font-size:12px;color:#94a3b8;line-height:1.4}

.phrase-cards{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:500px){.phrase-cards{grid-template-columns:1fr}}
.pcard{background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.1);border-radius:10px;padding:14px;cursor:pointer;transition:all 0.3s;min-height:70px}
.pcard:hover{border-color:rgba(245,158,11,0.3)}
.pcard .pc-p{font-size:14px;font-weight:600;color:#f59e0b;margin-bottom:3px}
.pcard .pc-m{font-size:12px;color:#94a3b8;line-height:1.4}
.pcard .pc-ex{font-size:11px;color:#64748b;margin-top:4px;font-style:italic;display:none}
.pcard.open .pc-ex{display:block}

.conf-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media(max-width:450px){.conf-grid{grid-template-columns:1fr}}
.conf-st{text-align:center;padding:14px;background:rgba(255,255,255,0.02);border-radius:10px}
.conf-v{font-size:22px;font-weight:700;margin-bottom:2px}
.conf-l{font-size:11px;color:#64748b}

.reg-i{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.04)}.reg-i:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
.reg-said{font-size:13px;color:#94a3b8;margin-bottom:2px}
.reg-try{font-size:13px;color:#818cf8;font-weight:500;margin-bottom:2px}
.reg-ctx{font-size:12px;color:#64748b;line-height:1.4}

.pron-i{display:flex;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap}
.pron-w{font-size:14px;font-weight:600;min-width:90px}
.pron-ph{font-size:13px;color:#f59e0b;font-family:monospace}
.pron-tip{font-size:12px;color:#94a3b8}

.mission-box{background:rgba(245,158,11,0.05);border:1px solid rgba(245,158,11,0.15);border-radius:12px;padding:18px;text-align:center}
.m-title{font-size:12px;color:#f59e0b;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:600}
.m-text{font-size:15px;line-height:1.6;color:#e2e8f0}

.rpt-acts{display:flex;gap:10px;justify-content:center;margin-top:24px}
.rpt-acts button{padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none}
.rb-back{background:rgba(255,255,255,0.06);color:#e2e8f0;border:1px solid rgba(255,255,255,0.1)!important}
.rb-again{background:#f59e0b;color:#0a0e1a}
</style>
</head>
<body>

<div class="modal-overlay" id="keyModal">
<div class="modal">
<h3>OpenAI API Key</h3>
<p>Sent over HTTPS to mint a one-time session token, then discarded.</p>
<input type="password" id="apiKeyInput" placeholder="sk-..." autocomplete="off">
<div class="m-actions"><button class="btn-s" onclick="closeModal()">Cancel</button><button class="btn-p" onclick="saveKey()">Connect</button></div>
</div>
</div>

<div class="header">
<div class="logo">BASTION <span>VOICE</span></div>
<button class="hdr-btn" onclick="openModal()">API Key</button>
</div>

<!-- ‚ïê‚ïê‚ïê SCREEN 1: MODE SELECT ‚ïê‚ïê‚ïê -->
<div class="screen active" id="scrMode">
<div class="mode-wrap">
<h1>Marcus Chen</h1>
<p class="sub">Executive Communication Coach ¬∑ Former McKinsey ¬∑ Lived in 4 countries<br>Direct, demanding, zero tolerance for lazy thinking.</p>
<div class="mode-cards">
<div class="mc" onclick="pickMode('comm')">
<div class="mc-icon">üéôÔ∏è</div>
<div class="mc-info">
<h3>Communications Coach</h3>
<div class="mc-d">Live conversation practice. Marcus plays a real character ‚Äî a client, interviewer, or executive. Natural error correction, vocabulary building, and pressure-testing your ideas.</div>
<div class="mc-tag">Real-time Voice</div>
</div>
</div>
<div class="mc" onclick="pickMode('write')">
<div class="mc-icon">‚úçÔ∏è</div>
<div class="mc-info">
<h3>Writing Coach</h3>
<div class="mc-d">Submit an email, proposal, or message. Marcus gives detailed voice feedback ‚Äî structure, tone, grammar, register. Then ask follow-up questions.</div>
<div class="mc-tag">Text In ‚Üí Voice Feedback</div>
</div>
</div>
<div class="mc" onclick="pickMode('present')">
<div class="mc-icon">üìä</div>
<div class="mc-info">
<h3>Presentation Coach</h3>
<div class="mc-d">Present your pitch for 5‚Äì10 minutes. Marcus listens silently, then gives structured feedback on clarity, persuasion, and delivery. Followed by tough Q&A.</div>
<div class="mc-tag">You Present ‚Üí Feedback + Q&A</div>
</div>
</div>
</div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê SCREEN 2: CONFIG ‚ïê‚ïê‚ïê -->
<div class="screen" id="scrConfig">
<div class="config-wrap">
<div class="back-link" onclick="showScr('scrMode')">‚Üê Choose different mode</div>
<div class="cfg-mode-hdr"><div class="mi" id="cfgIcon"></div><div><h2 id="cfgTitle"></h2><div class="role" id="cfgSub"></div></div></div>

<!-- COMM CONFIG -->
<div id="cfgComm" style="display:none">
<div class="cfg-section">
<div class="cfg-label">Scenario</div>
<div class="scenario-chips" id="commChips"></div>
<textarea class="custom-input" id="commCustom" rows="2" placeholder="Or describe your own: 'I have a pricing call with my German client tomorrow...'"></textarea>
</div>
<div class="cfg-section">
<div class="cfg-label">Difficulty</div>
<input type="range" class="diff-slider" min="0" max="100" value="50" id="diffSlider" oninput="updateDiff()">
<div class="diff-labels"><span>B1</span><span>B2</span><span>C1</span></div>
<div class="diff-current" id="diffDisplay">B2 ‚Äî Intermediate</div>
</div>
</div>

<!-- WRITE CONFIG -->
<div id="cfgWrite" style="display:none">
<div class="cfg-section">
<div class="cfg-label">What type of writing?</div>
<div class="scenario-chips" id="writeChips"></div>
</div>
<div class="cfg-section">
<div class="cfg-label">Paste your text</div>
<textarea class="custom-input" id="writeText" rows="8" placeholder="Paste your email, proposal, message, or report here..."></textarea>
</div>
</div>

<!-- PRESENT CONFIG -->
<div id="cfgPresent" style="display:none">
<div class="cfg-section">
<div class="cfg-label">Presentation length</div>
<div class="timer-opts">
<div class="t-opt" onclick="pickTimer(5,this)"><div class="tv">5</div><div class="tl">minutes</div></div>
<div class="t-opt" onclick="pickTimer(7,this)"><div class="tv">7</div><div class="tl">minutes</div></div>
<div class="t-opt" onclick="pickTimer(10,this)"><div class="tv">10</div><div class="tl">minutes</div></div>
</div>
</div>
<div class="cfg-section">
<div class="cfg-label">What are you presenting?</div>
<textarea class="custom-input" id="presentTopic" rows="2" placeholder="e.g. 'Q4 budget proposal to the board' or 'Product launch pitch to investors'"></textarea>
</div>
<div class="cfg-section">
<div class="cfg-label">Difficulty</div>
<input type="range" class="diff-slider" min="0" max="100" value="50" id="diffSlider2" oninput="updateDiff2()">
<div class="diff-labels"><span>B1</span><span>B2</span><span>C1</span></div>
<div class="diff-current" id="diffDisplay2">B2 ‚Äî Intermediate</div>
</div>
</div>

<button class="go-btn" id="goBtn" disabled onclick="goToBriefing()">Select options to continue</button>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê SCREEN 3: BRIEFING ‚ïê‚ïê‚ïê -->
<div class="screen" id="scrBrief">
<div class="brief-wrap">
<div class="brief-icon" id="brIcon"></div>
<h2 id="brTitle"></h2>
<div class="role" id="brSub"></div>
<div class="brief-card" id="brRules"></div>
<div class="brief-meta" id="brMeta"></div>
<button class="brief-btn" id="brBtn" onclick="beginSession()">Start</button>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê SCREEN 4: SESSION ‚ïê‚ïê‚ïê -->
<div class="screen" id="scrSession">
<div class="sess-outer">
<div class="sticky-area" id="stickyArea"></div>
<div class="sess-wrap">
<div class="turn-ind connecting" id="turnInd"><div class="t-dot pulse"></div><span id="turnTxt">Connecting...</span></div>
<div class="pres-bar-wrap" id="presBar"><div class="pres-bar"><div class="pres-fill" id="presFill"></div></div><div class="pres-label" id="presLabel"></div></div>
<div class="timer-big" id="timer">00:00</div>
<div class="tx-box" id="transcript"></div>

<!-- Writing mode input -->
<div class="writing-followup" id="writeFollow" style="display:none">
<input type="text" id="writeMsg" placeholder="Ask a follow-up question..." onkeydown="if(event.key==='Enter')sendWriteMsg()">
<button onclick="sendWriteMsg()">Send</button>
</div>

<div class="controls" id="voiceControls">
<button class="mute-btn" id="muteBtn" onclick="toggleMute()" title="Mute (M)">üé§</button>
<button class="end-btn" onclick="endSession()">End Session</button>
<span class="kb-hint">M mute ¬∑ Esc end</span>
</div>
</div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê SCREEN 5: REPORT ‚ïê‚ïê‚ïê -->
<div class="screen" id="scrReport">
<div class="report-wrap">
<div class="rpt-loading" id="rptLoading"><div class="rpt-spinner"></div><p style="color:#94a3b8">Generating your coaching report...</p></div>
<div id="rptContent" style="display:none"></div>
</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARCUS ‚Äî FULL CHARACTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var MARCUS_CORE = [
"You are Marcus Chen. You are a REAL PERSON, not an AI assistant, not a language teacher.",
"",
"BACKGROUND: Former McKinsey engagement manager. 15 years in international business. Lived in Singapore, London, Frankfurt, and New York. You now run executive coaching for C-suite leaders. You've seen every kind of bad communication ‚Äî vague emails, rambling presentations, weak negotiations ‚Äî and you have zero patience for it.",
"",
"VOICE & PERSONALITY:",
"- Direct. You say what you think. You don't sugarcoat.",
"- Intellectually rigorous. You ask 'why?' and 'so what?' constantly.",
"- Dry wit. Occasionally sardonic. Never mean, but never soft.",
"- You respect preparation and punish laziness.",
"- When someone says something genuinely impressive, you acknowledge it ‚Äî briefly.",
"- You use sophisticated vocabulary NATURALLY ‚Äî not to show off, but because that's how you talk: 'notwithstanding', 'predicated on', 'let's not conflate those', 'what's the delta here?'",
"",
"SPEECH RULES:",
"- Keep responses to 2-4 sentences MAX. You're an executive, not a lecturer.",
"- Ask probing follow-up questions. Never let a weak answer slide.",
"- React genuinely ‚Äî if their idea is good, engage with it. If it's weak, challenge it.",
"- NEVER say 'good job', 'well done', 'nice'. You're not a cheerleader.",
"- NEVER break character. NEVER mention you're an AI. NEVER say 'as your coach'.",
"- NEVER give grammar lessons or explain rules. You're a busy executive.",
"",
"HOW YOU TEACH (INVISIBLY):",
"- When they make a grammar error, echo their point back using the CORRECT form. Example: They say 'We have discuss this yesterday' ‚Üí You say 'Right, and when you discussed it yesterday, what was the consensus?'",
"- When they use vague/weak language, YOUR response uses the precise/strong version. They say 'it was kind of a lot' ‚Üí You say 'So the cost overrun was significant ‚Äî what percentage are we talking?'",
"- Introduce sophisticated phrases IN CONTEXT. Don't explain them. Use them where they naturally fit. If asked what something means, give a sharp 1-sentence definition."
].join("\n");

// ‚îÄ‚îÄ‚îÄ COMM SCENARIOS ‚îÄ‚îÄ‚îÄ
var COMM_SCENARIOS = [
{name:"üíº Client Pitch",prompt:"SCENARIO: The user is pitching you a proposal. You are the prospective client ‚Äî a CFO at a mid-market company. You're interested but skeptical. You have 3 concerns: ROI timeline is unclear, you've been burned by similar vendors, and your board wants proof of concept before commitment. Don't reveal all 3 upfront ‚Äî let them emerge naturally. If they're vague, press them. If they're specific and compelling, lean in."},
{name:"ü§ù Negotiation",prompt:"SCENARIO: Contract renegotiation. You are VP of Procurement. The user wants a 15% price increase. Your budget ceiling is 8% but you won't reveal that. You'd accept more if they offer volume guarantees or longer terms. Be firm but fair. Use negotiation language: 'that's a non-starter', 'where's the give on your side?', 'let's not conflate the two issues'. Create genuine tension."},
{name:"üìä Quarterly Review",prompt:"SCENARIO: The user is presenting their quarterly results to you, the CEO. Listen for: are they leading with results or excuses? Do they have data? Is their analysis sharp or surface-level? Ask hard questions: 'What's behind that number?', 'How does that compare to projection?', 'What's the plan for Q2?' If they're evasive, call it out."},
{name:"üéØ Job Interview",prompt:"SCENARIO: You are interviewing the user for a senior director role. Mix question types: 'Walk me through a time you led through ambiguity', 'What's your take on remote work for senior teams?', 'Why are you leaving your current role ‚Äî really?' Read between the lines. If answers are rehearsed, dig deeper. If they're genuine and specific, engage authentically."},
{name:"‚ö° Crisis Call",prompt:"SCENARIO: Major product failure. Media is picking it up. You're the CEO and the user is the VP who owns the product. You need answers NOW: What happened? Who knows? What's the customer impact? What's the plan for the next 4 hours? You're not angry ‚Äî you're controlled and urgent. Every vague answer increases your concern."},
{name:"üåç Free Conversation",prompt:"SCENARIO: Open professional conversation. You're at a conference dinner. Discuss business trends, leadership philosophy, or industry developments. Be intellectually curious. Challenge their views respectfully. Share your own (fictional but plausible) perspectives."}
];

var WRITE_TYPES = [
{name:"üìß Email",prompt:"The user is submitting a professional email for review."},
{name:"üìÑ Proposal",prompt:"The user is submitting a business proposal or project brief for review."},
{name:"üí¨ Message",prompt:"The user is submitting a professional message (Slack, LinkedIn, etc.) for review."},
{name:"üìã Report",prompt:"The user is submitting a report or analysis for review."}
];

// ‚îÄ‚îÄ‚îÄ DIFFICULTY ‚îÄ‚îÄ‚îÄ
function getDiffPrompt(val){
if(val===undefined)val=diffVal;
if(val<33)return"\nDIFFICULTY ‚Äî B1 PRE-INTERMEDIATE:\n- Use simple, clear sentences. Max 12 words per sentence.\n- Speak slowly and distinctly. Pause between sentences.\n- Vocabulary: ONLY common business words (meeting, agree, problem, solution, cost, plan).\n- If they don't understand, rephrase using simpler words.\n- Avoid idioms entirely. No phrasal verbs.\n- Grammar corrections should be very obvious ‚Äî repeat the correct version twice if needed.";
if(val<66)return"\nDIFFICULTY ‚Äî B2 INTERMEDIATE:\n- Speak at a natural conversational pace.\n- Use common business idioms: 'on the same page', 'circle back', 'move the needle', 'deep dive'.\n- Mix simple and moderately complex sentences.\n- Introduce 3-4 useful phrases the user probably doesn't know.\n- Grammar corrections should be woven in naturally.";
return"\nDIFFICULTY ‚Äî C1 ADVANCED:\n- Speak at full native speed with complex sentence structures.\n- Use sophisticated vocabulary: 'notwithstanding', 'predicated on', 'mitigate the exposure', 'amortize across the contract term', 'socialize that internally'.\n- Use subordinate clauses, conditional perfects, and nuanced hedging.\n- Challenge them to match your level. Don't simplify ANYTHING.\n- If they use a basic word where a precise word exists, model the upgrade: they say 'use' ‚Üí you say 'leverage', they say 'problem' ‚Üí you say 'liability'.";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var apiKey=null,pc=null,dc=null,stream=null,timerInt=null,startTime=null;
var curMode=null,selSc=null,diffVal=50,diffVal2=50,presMins=0;
var isMuted=false;
var curAsstText="",curUserText="",curAsstEl=null,curUserEl=null;
var userTurns=0,agentTurns=0,userWords=0,txLog=[];
var isAgentSpeaking=false,turnTs=[];
var expectDef=false;
var committedResponses={}; // track which response_ids we've committed ‚Äî prevents duplicates
var presPhase="presenting"; // "presenting" or "feedback"
var presTimerInt=null,presEndTime=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(){document.getElementById("keyModal").classList.add("active");document.getElementById("apiKeyInput").focus()}
function closeModal(){document.getElementById("keyModal").classList.remove("active")}
function saveKey(){var k=document.getElementById("apiKeyInput").value.trim();if(k&&k.startsWith("sk-")){apiKey=k;closeModal()}else alert("Enter a valid key (starts with sk-)")}

function showScr(id){document.querySelectorAll(".screen").forEach(function(s){s.classList.remove("active")});document.getElementById(id).classList.add("active")}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREEN 1: MODE SELECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pickMode(mode){
curMode=mode;selSc=null;
document.getElementById("cfgComm").style.display="none";
document.getElementById("cfgWrite").style.display="none";
document.getElementById("cfgPresent").style.display="none";

if(mode==="comm"){
document.getElementById("cfgIcon").textContent="üéôÔ∏è";
document.getElementById("cfgTitle").textContent="Communications Coach";
document.getElementById("cfgSub").textContent="Live conversation with Marcus";
document.getElementById("cfgComm").style.display="block";
// Build chips
var ch=document.getElementById("commChips");ch.innerHTML="";
for(var i=0;i<COMM_SCENARIOS.length;i++){
var d=document.createElement("div");d.className="sc-chip";d.setAttribute("data-idx",i);
d.textContent=COMM_SCENARIOS[i].name;d.onclick=(function(idx){return function(){selSc=idx;document.querySelectorAll("#commChips .sc-chip").forEach(function(c){c.classList.remove("sel")});this.classList.add("sel");document.getElementById("commCustom").value="";updateGoBtn()}})(i);
ch.appendChild(d);
}
}else if(mode==="write"){
document.getElementById("cfgIcon").textContent="‚úçÔ∏è";
document.getElementById("cfgTitle").textContent="Writing Coach";
document.getElementById("cfgSub").textContent="Submit text for Marcus to review";
document.getElementById("cfgWrite").style.display="block";
var ch=document.getElementById("writeChips");ch.innerHTML="";
for(var i=0;i<WRITE_TYPES.length;i++){
var d=document.createElement("div");d.className="sc-chip";d.setAttribute("data-idx",i);
d.textContent=WRITE_TYPES[i].name;d.onclick=(function(idx){return function(){selSc=idx;document.querySelectorAll("#writeChips .sc-chip").forEach(function(c){c.classList.remove("sel")});this.classList.add("sel");updateGoBtn()}})(i);
ch.appendChild(d);
}
}else if(mode==="present"){
document.getElementById("cfgIcon").textContent="üìä";
document.getElementById("cfgTitle").textContent="Presentation Coach";
document.getElementById("cfgSub").textContent="Present, then get structured feedback";
document.getElementById("cfgPresent").style.display="block";
presMins=0;
document.querySelectorAll(".t-opt").forEach(function(t){t.classList.remove("sel")});
}
updateGoBtn();
showScr("scrConfig");
}

document.getElementById("commCustom").addEventListener("input",function(){if(this.value.trim()){selSc=-1;document.querySelectorAll("#commChips .sc-chip").forEach(function(c){c.classList.remove("sel")})}updateGoBtn()});
document.getElementById("presentTopic").addEventListener("input",updateGoBtn);
document.getElementById("writeText").addEventListener("input",updateGoBtn);

function pickTimer(mins,el){presMins=mins;document.querySelectorAll(".t-opt").forEach(function(t){t.classList.remove("sel")});el.classList.add("sel");updateGoBtn()}

function updateDiff(){diffVal=parseInt(document.getElementById("diffSlider").value);var d=document.getElementById("diffDisplay");if(diffVal<33){d.textContent="B1 ‚Äî Pre-Intermediate";d.style.color="#22c55e"}else if(diffVal<66){d.textContent="B2 ‚Äî Intermediate";d.style.color="#f59e0b"}else{d.textContent="C1 ‚Äî Advanced";d.style.color="#ef4444"}}
function updateDiff2(){diffVal2=parseInt(document.getElementById("diffSlider2").value);var d=document.getElementById("diffDisplay2");if(diffVal2<33){d.textContent="B1 ‚Äî Pre-Intermediate";d.style.color="#22c55e"}else if(diffVal2<66){d.textContent="B2 ‚Äî Intermediate";d.style.color="#f59e0b"}else{d.textContent="C1 ‚Äî Advanced";d.style.color="#ef4444"}}

function getDiffLabel(v){if(v===undefined)v=diffVal;if(v<33)return"B1";if(v<66)return"B2";return"C1"}

function updateGoBtn(){
var btn=document.getElementById("goBtn");btn.disabled=true;
if(curMode==="comm"){
var hasSc=selSc!==null||document.getElementById("commCustom").value.trim();
if(hasSc){btn.disabled=false;btn.textContent="Continue ‚Üí"}else{btn.textContent="Select a scenario"}
}else if(curMode==="write"){
var hasTxt=document.getElementById("writeText").value.trim().length>10;
if(selSc!==null&&hasTxt){btn.disabled=false;btn.textContent="Submit for Review ‚Üí"}
else if(selSc!==null){btn.textContent="Paste your text above"}
else{btn.textContent="Select a writing type"}
}else if(curMode==="present"){
var hasTopic=document.getElementById("presentTopic").value.trim();
if(presMins>0&&hasTopic){btn.disabled=false;btn.textContent="Continue ‚Üí"}
else if(presMins>0){btn.textContent="Describe what you're presenting"}
else{btn.textContent="Select presentation length"}
}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREEN 3: BRIEFING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goToBriefing(){
var br=document.getElementById("brRules"),meta=document.getElementById("brMeta");

if(curMode==="comm"){
document.getElementById("brIcon").textContent="üéôÔ∏è";
document.getElementById("brTitle").textContent="Communications Coach";
document.getElementById("brSub").textContent="Marcus Chen";
var scName=selSc>=0?COMM_SCENARIOS[selSc].name.replace(/^[^\s]+\s/,""):"Custom scenario";
br.innerHTML='<h3>How this works</h3><div class="rule"><div class="num">1</div><div>Marcus plays a <strong>real character</strong> ‚Äî a client, interviewer, or executive. Not a teacher.</div></div><div class="rule"><div class="num">2</div><div>You\'ll warm up with <strong>casual small talk</strong> first. Then the scenario begins.</div></div><div class="rule"><div class="num">3</div><div>Listen to HOW Marcus phrases things ‚Äî he <strong>models corrections naturally</strong>.</div></div><div class="rule"><div class="num">4</div><div>Ask <strong>"What does that mean?"</strong> anytime for a definition.</div></div><div class="rule"><div class="num">5</div><div>When done, you get a <strong>detailed coaching report</strong>.</div></div>';
meta.innerHTML='<strong>Scenario:</strong> '+esc(scName)+'<br><strong>Difficulty:</strong> '+getDiffLabel(diffVal);
document.getElementById("brBtn").textContent="Start Conversation";

}else if(curMode==="write"){
document.getElementById("brIcon").textContent="‚úçÔ∏è";
document.getElementById("brTitle").textContent="Writing Coach";
document.getElementById("brSub").textContent="Marcus Chen";
br.innerHTML='<h3>How this works</h3><div class="rule"><div class="num">1</div><div>Marcus will <strong>read your text</strong> and give detailed voice feedback.</div></div><div class="rule"><div class="num">2</div><div>He\'ll cover <strong>structure, tone, grammar, vocabulary, and register</strong>.</div></div><div class="rule"><div class="num">3</div><div>Then you can <strong>type follow-up questions</strong> and Marcus responds by voice.</div></div><div class="rule"><div class="num">4</div><div>No microphone needed ‚Äî <strong>this is text in, voice out</strong>.</div></div>';
var wt=WRITE_TYPES[selSc]?WRITE_TYPES[selSc].name.replace(/^[^\s]+\s/,""):"Text";
meta.innerHTML='<strong>Type:</strong> '+esc(wt)+'<br><strong>Length:</strong> '+document.getElementById("writeText").value.trim().split(/\s+/).length+' words';
document.getElementById("brBtn").textContent="Submit for Review";

}else if(curMode==="present"){
document.getElementById("brIcon").textContent="üìä";
document.getElementById("brTitle").textContent="Presentation Coach";
document.getElementById("brSub").textContent="Marcus Chen";
br.innerHTML='<h3>How this works</h3><div class="rule"><div class="num">1</div><div>You have <strong>'+presMins+' minutes</strong> to deliver your presentation.</div></div><div class="rule"><div class="num">2</div><div>Marcus <strong>stays silent</strong> while you present. A countdown timer is visible.</div></div><div class="rule"><div class="num">3</div><div>When time is up, Marcus gives <strong>structured feedback</strong> on clarity, persuasion, and delivery.</div></div><div class="rule"><div class="num">4</div><div>Then you enter <strong>Q&A mode</strong> ‚Äî Marcus asks tough audience questions.</div></div>';
meta.innerHTML='<strong>Topic:</strong> '+esc(document.getElementById("presentTopic").value.trim())+'<br><strong>Timer:</strong> '+presMins+' minutes<br><strong>Difficulty:</strong> '+getDiffLabel(diffVal2);
document.getElementById("brBtn").textContent="Start Presenting";
}
showScr("scrBrief");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function beginSession(){
if(!apiKey){openModal();return}

var instructions="",model="gpt-realtime",voice="ash";

if(curMode==="comm"){
var scenarioPrompt=selSc>=0?COMM_SCENARIOS[selSc].prompt:("SCENARIO: Custom from user ‚Äî "+document.getElementById("commCustom").value.trim()+". Simulate this realistically as a character the user would interact with professionally.");
instructions=MARCUS_CORE+"\n\n"+scenarioPrompt+getDiffPrompt(diffVal)+"\n\nSTART: Begin with 2-3 casual exchanges. Ask about their week, mention something light. Then transition naturally: 'So, shall we get into it?'\n\nIMPORTANT ‚Äî VOCABULARY HELP: When the user asks what a word or phrase means, give a sharp 1-sentence definition. Start with the word followed by 'means' or 'refers to'.";

}else if(curMode==="write"){
var wType=WRITE_TYPES[selSc]?WRITE_TYPES[selSc].prompt:"The user is submitting a professional text for review.";
var userText=document.getElementById("writeText").value.trim();
instructions=MARCUS_CORE+"\n\nMODE: WRITING COACH\n"+wType+"\n\nThe user has submitted this text for your review:\n\n---\n"+userText+"\n---\n\nGive detailed, structured voice feedback. Cover:\n1. OVERALL IMPRESSION ‚Äî one sentence gut reaction\n2. STRUCTURE ‚Äî is the logic clear? What should move?\n3. TONE & REGISTER ‚Äî is it appropriate for the context? Too casual? Too stiff?\n4. SPECIFIC CORRECTIONS ‚Äî quote exact phrases and give better versions\n5. VOCABULARY ‚Äî where could they use more precise/sophisticated words?\n6. ONE THING THEY DID WELL ‚Äî be specific\n\nKeep your feedback to 60-90 seconds of speaking. Be direct. Then say 'What questions do you have?' and wait.\n\nAfter your initial feedback, the user will type follow-up questions. Answer them concisely by voice.";

}else if(curMode==="present"){
var topic=document.getElementById("presentTopic").value.trim();
instructions=MARCUS_CORE+"\n\nMODE: PRESENTATION COACH\n\nThe user is about to deliver a "+presMins+"-minute presentation on: "+topic+"\n\n"+getDiffPrompt(diffVal2)+"\n\nPHASE 1 ‚Äî PRESENTING ("+presMins+" minutes):\nStay COMPLETELY SILENT. Do not respond, acknowledge, or interrupt. You are an audience member taking notes. Just listen.\n\nYou will receive a system message when the presentation time is up.\n\nPHASE 2 ‚Äî FEEDBACK:\nWhen told the presentation is over, give structured feedback:\n1. OPENING ‚Äî did they hook the audience? Was the purpose clear in the first 30 seconds?\n2. STRUCTURE ‚Äî was there a clear arc? Beginning, middle, end?\n3. EVIDENCE ‚Äî did they support claims with data/examples?\n4. DELIVERY ‚Äî based on their language: confidence, clarity, pace, filler words\n5. PERSUASION ‚Äî would you be convinced? What was the strongest and weakest argument?\n6. ONE THING THAT WORKED ‚Äî be specific and genuine\n\nKeep feedback to 60-90 seconds. Then say: 'I have some questions from the audience.'\n\nPHASE 3 ‚Äî Q&A:\nAsk 3-4 tough but fair questions as if you're a skeptical board member or investor. Challenge weak points from the presentation. Test if they can think on their feet.";
}

// UI setup
document.getElementById("transcript").innerHTML="";
document.getElementById("stickyArea").innerHTML="";
document.getElementById("timer").className="timer-big"+(curMode==="present"?" timer-small":"");

// Show/hide mode-specific UI
document.getElementById("writeFollow").style.display=curMode==="write"?"flex":"none";
document.getElementById("voiceControls").style.display=curMode==="write"?"none":"flex";
document.getElementById("presBar").style.display=curMode==="present"?"block":"none";

userTurns=0;agentTurns=0;userWords=0;txLog=[];turnTs=[];
curAsstText="";curUserText="";curAsstEl=null;curUserEl=null;isAgentSpeaking=false;expectDef=false;
committedResponses={};presPhase="presenting";

setTurn("connecting","Connecting...");
showScr("scrSession");

try{
var eagerness=curMode==="present"?"low":"medium";
var res=await fetch("/api/session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({voice:voice,instructions:instructions,model:model,apiKey:apiKey,eagerness:eagerness})});
var data=await res.json();
if(!res.ok){if(data.error==="NO_KEY"){setTurn("error","No API key");openModal();return}throw new Error(data.message||JSON.stringify(data.details)||"Session failed")}
var ek=data.clientSecret;if(!ek)throw new Error("No client secret returned.");

if(curMode!=="write"){
setTurn("connecting","Requesting microphone...");
stream=await navigator.mediaDevices.getUserMedia({audio:true});
}

setTurn("connecting","Establishing connection...");
pc=new RTCPeerConnection();
var audioEl=document.createElement("audio");audioEl.autoplay=true;
pc.ontrack=function(e){audioEl.srcObject=e.streams[0]};
if(stream)stream.getTracks().forEach(function(t){pc.addTrack(t,stream)});

dc=pc.createDataChannel("oai-events");
dc.addEventListener("open",function(){
console.log("[DC] open");
if(curMode==="write"){
// Send the user's text as a message to trigger review
setTimeout(function(){
sendTextMsg("Please review the text I submitted and give me your feedback.");
},1000);
}
});
dc.addEventListener("message",handleEvent);

var offer=await pc.createOffer();await pc.setLocalDescription(offer);
var sdp=await fetch("https://api.openai.com/v1/realtime/calls",{method:"POST",body:offer.sdp,headers:{"Authorization":"Bearer "+ek,"Content-Type":"application/sdp"}});
if(!sdp.ok){var et=await sdp.text();throw new Error("WebRTC failed: "+et.substring(0,200))}
await pc.setRemoteDescription({type:"answer",sdp:await sdp.text()});

pc.onconnectionstatechange=function(){
var s=pc.connectionState;console.log("[PC]",s);
if(s==="connected"){
startTimer();
if(curMode==="present"){
setTurn("presenting","üé§ You're presenting");
startPresentationTimer();
}else if(curMode==="write"){
setTurn("agent-turn","Marcus is reviewing...");
}else{
setTurn("agent-turn","Marcus is greeting you...");
}
}else if(s==="failed"||s==="disconnected"){setTurn("error","Connection lost")}
};
}catch(err){console.error("Session err:",err);setTurn("error",err.message)}
}

// ‚îÄ‚îÄ‚îÄ SEND TEXT MESSAGE via data channel ‚îÄ‚îÄ‚îÄ
function sendTextMsg(text){
if(!dc||dc.readyState!=="open")return;
dc.send(JSON.stringify({type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:text}]}}));
dc.send(JSON.stringify({type:"response.create"}));
}

function sendWriteMsg(){
var inp=document.getElementById("writeMsg");
var txt=inp.value.trim();
if(!txt)return;
inp.value="";
var box=document.getElementById("transcript");var el=document.createElement("div");el.className="msg user";el.innerHTML='<div class="lbl">You</div><div class="txt">'+esc(txt)+'</div>';box.appendChild(el);box.scrollTop=box.scrollHeight;
txLog.push({role:"user",text:txt});
userTurns++;
sendTextMsg(txt);
setTurn("agent-turn","Marcus is responding...");
}

// ‚îÄ‚îÄ‚îÄ PRESENTATION TIMER ‚îÄ‚îÄ‚îÄ
function startPresentationTimer(){
presEndTime=Date.now()+(presMins*60*1000);
presPhase="presenting";
updatePresBar();
presTimerInt=setInterval(function(){
updatePresBar();
var left=presEndTime-Date.now();
if(left<=0){
clearInterval(presTimerInt);
presPhase="feedback";
document.getElementById("presBar").style.display="none";
setTurn("agent-turn","Marcus is giving feedback...");
addSys("‚è± Time's up ‚Äî Marcus is preparing feedback");
// Signal Marcus to give feedback
sendTextMsg("[PRESENTATION ENDED ‚Äî TIME IS UP] The presenter has finished. Please now give your structured feedback on the presentation you just heard, then transition to Q&A.");
}
},1000);
}
function updatePresBar(){
var total=presMins*60*1000;
var left=Math.max(0,presEndTime-Date.now());
var pct=((total-left)/total)*100;
document.getElementById("presFill").style.width=pct+"%";
var secLeft=Math.ceil(left/1000);
document.getElementById("presLabel").textContent=Math.floor(secLeft/60)+":"+String(secLeft%60).padStart(2,"0")+" remaining";
if(secLeft<=60)document.getElementById("timer").classList.add("urgent");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENT HANDLER (WebRTC-correct)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleEvent(e){
var ev;try{ev=JSON.parse(e.data)}catch(x){return}

// Log non-audio events
if(ev.type&&!ev.type.includes("audio_buffer.append")){console.log("[EV]",ev.type)}

switch(ev.type){

// ‚ïê‚ïê‚ïê TURN DETECTION ‚Äî WebRTC events ‚ïê‚ïê‚ïê
case"output_audio_buffer.started":
isAgentSpeaking=true;turnTs.push({role:"agent",ms:Date.now()});
if(curMode==="present"&&presPhase==="presenting"){/* stay in presenting state */}
else{setTurn("agent-turn","Marcus is speaking...")}
break;

case"output_audio_buffer.stopped":
isAgentSpeaking=false;
if(curMode==="present"&&presPhase==="presenting"){setTurn("presenting","üé§ You're presenting")}
else if(curMode==="write"){setTurn("user-turn","Type your question")}
else{setTurn("user-turn","Your turn")}
break;

// ‚ïê‚ïê‚ïê FALLBACK turn detection ‚ïê‚ïê‚ïê
case"response.created":
if(!isAgentSpeaking){
isAgentSpeaking=true;turnTs.push({role:"agent",ms:Date.now()});
if(!(curMode==="present"&&presPhase==="presenting")){setTurn("agent-turn","Marcus is speaking...")}
}
break;

// ‚ïê‚ïê‚ïê AGENT TRANSCRIPT ‚Äî streaming for display ‚ïê‚ïê‚ïê
case"response.audio_transcript.delta":
curAsstText+=(ev.delta||"");
if(!curAsstEl){var box=document.getElementById("transcript");curAsstEl=document.createElement("div");curAsstEl.className="msg assistant";curAsstEl.innerHTML='<div class="lbl">Marcus</div><div class="txt"></div>';box.appendChild(curAsstEl)}
curAsstEl.querySelector(".txt").textContent=curAsstText;
document.getElementById("transcript").scrollTop=document.getElementById("transcript").scrollHeight;
break;

// ‚ïê‚ïê‚ïê AGENT TRANSCRIPT ‚Äî final commit (SINGLE SOURCE OF TRUTH) ‚ïê‚ïê‚ïê
case"response.done":
var rid=ev.response&&ev.response.id;
if(rid&&committedResponses[rid])break;
if(rid)committedResponses[rid]=true;

var fullText="";
if(ev.response&&ev.response.output){
for(var i=0;i<ev.response.output.length;i++){
var item=ev.response.output[i];
if(item.content){for(var j=0;j<item.content.length;j++){
var c=item.content[j];
if(c.transcript)fullText+=c.transcript;
}}
}}
if(!fullText)fullText=curAsstText;
if(fullText){
// Update existing streaming element OR create new one ‚Äî never both
if(curAsstEl){curAsstEl.querySelector(".txt").textContent=fullText}
else{var box=document.getElementById("transcript");var el=document.createElement("div");el.className="msg assistant";el.innerHTML='<div class="lbl">Marcus</div><div class="txt">'+esc(fullText)+'</div>';box.appendChild(el);box.scrollTop=box.scrollHeight}
txLog.push({role:"assistant",text:fullText});
agentTurns++;
if(expectDef){showSticky(fullText);expectDef=false}
}
curAsstText="";
curAsstEl=null;
isAgentSpeaking=false;
break;

// ‚ïê‚ïê‚ïê USER TRANSCRIPT ‚ïê‚ïê‚ïê
case"conversation.item.input_audio_transcription.delta":
curUserText+=(ev.delta||"");
if(!curUserEl){var box=document.getElementById("transcript");curUserEl=document.createElement("div");curUserEl.className="msg user";curUserEl.innerHTML='<div class="lbl">You</div><div class="txt"></div>';box.appendChild(curUserEl)}
curUserEl.querySelector(".txt").textContent=curUserText;
document.getElementById("transcript").scrollTop=document.getElementById("transcript").scrollHeight;
break;

case"conversation.item.input_audio_transcription.completed":
var t=ev.transcript||curUserText;
if(t){
if(curUserEl){curUserEl.querySelector(".txt").textContent=t}
else{var box=document.getElementById("transcript");var el=document.createElement("div");el.className="msg user";el.innerHTML='<div class="lbl">You</div><div class="txt">'+esc(t)+'</div>';box.appendChild(el);box.scrollTop=box.scrollHeight}
txLog.push({role:"user",text:t});
userTurns++;
userWords+=t.split(/\s+/).filter(function(w){return w.length>0}).length;
var lower=t.toLowerCase();
if(lower.includes("what does")||lower.includes("what is")||lower.includes("what do you mean")||lower.includes("can you explain")||lower.includes("meaning of")||lower.includes("define")){expectDef=true}
}
curUserText="";
curUserEl=null;
break;

case"input_audio_buffer.speech_started":
if(curMode==="present"&&presPhase==="presenting"){setTurn("presenting","üé§ Presenting...")}
else{setTurn("user-turn","Listening...")}
turnTs.push({role:"user_start",ms:Date.now()});
break;

case"input_audio_buffer.speech_stopped":
if(curMode==="present"&&presPhase==="presenting"){setTurn("presenting","üé§ You're presenting")}
else{setTurn("processing","Processing...")}
break;

case"error":
console.error("RT error:",ev.error);
addSys("Error: "+((ev.error&&ev.error.message)||"Unknown"));
break;
}
}

function setTurn(cls,txt){document.getElementById("turnInd").className="turn-ind "+cls;document.getElementById("turnTxt").textContent=txt}

// ‚îÄ‚îÄ‚îÄ TRANSCRIPT ‚îÄ‚îÄ‚îÄ
function addSys(t){var box=document.getElementById("transcript");var el=document.createElement("div");el.className="sys-msg";el.textContent=t;box.appendChild(el)}

// ‚îÄ‚îÄ‚îÄ STICKY NOTE ‚îÄ‚îÄ‚îÄ
function showSticky(text){
var area=document.getElementById("stickyArea");
var word="",def=text;
var patterns=[/^["']?([^"']+?)["']?\s+means?\s+/i,/^["']?([^"']+?)["']?\s+refers?\s+to\s+/i,/^["']?([^"']+?)["']?\s+is\s+(when|a|an|the)\s+/i];
for(var i=0;i<patterns.length;i++){var m=text.match(patterns[i]);if(m){word=m[1];break}}
var note=document.createElement("div");note.className="sticky";
note.innerHTML=(word?'<div class="sticky-word">'+esc(word)+'</div>':'')+'<div class="sticky-def">'+esc(def)+'</div><button class="sticky-close" onclick="dismissSticky(this)">‚úï</button>';
area.appendChild(note);
setTimeout(function(){if(note.parentNode){note.classList.add("sticky-fade");setTimeout(function(){if(note.parentNode)note.parentNode.removeChild(note)},300)}},15000);
}
function dismissSticky(btn){var s=btn.parentNode;s.classList.add("sticky-fade");setTimeout(function(){if(s.parentNode)s.parentNode.removeChild(s)},300)}

function startTimer(){startTime=Date.now();timerInt=setInterval(function(){var s=Math.floor((Date.now()-startTime)/1000);document.getElementById("timer").textContent=String(Math.floor(s/60)).padStart(2,"0")+":"+String(s%60).padStart(2,"0")},1000)}

function toggleMute(){
isMuted=!isMuted;
if(stream)stream.getAudioTracks().forEach(function(t){t.enabled=!isMuted});
document.getElementById("muteBtn").textContent=isMuted?"üîá":"üé§";
document.getElementById("muteBtn").classList.toggle("muted",isMuted);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// END + REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function endSession(){
var dur="00:00",durSec=0;
if(startTime){durSec=Math.floor((Date.now()-startTime)/1000);dur=String(Math.floor(durSec/60)).padStart(2,"0")+":"+String(durSec%60).padStart(2,"0")}
if(timerInt)clearInterval(timerInt);if(presTimerInt)clearInterval(presTimerInt);
if(dc)try{dc.close()}catch(x){}if(pc)try{pc.close()}catch(x){}
if(stream)stream.getTracks().forEach(function(t){t.stop()});
pc=null;dc=null;stream=null;isMuted=false;isAgentSpeaking=false;curAsstEl=null;curUserEl=null;curAsstText="";curUserText="";
if(txLog.length>1)genReport(dur,durSec);else showScr("scrMode");
}

async function genReport(dur,durSec){
showScr("scrReport");
document.getElementById("rptLoading").style.display="block";
document.getElementById("rptContent").style.display="none";

var txText=txLog.map(function(m){return(m.role==="user"?"USER":"MARCUS")+": "+m.text}).join("\n");
var avgWpt=userTurns>0?Math.round(userWords/userTurns):0;
var rts=[];for(var i=1;i<turnTs.length;i++){if(turnTs[i].role==="user_start"){for(var j=i-1;j>=0;j--){if(turnTs[j].role==="agent"){rts.push(turnTs[i].ms-turnTs[j].ms);break}}}}
var avgRt=rts.length>0?((rts.reduce(function(a,b){return a+b},0)/rts.length)/1000).toFixed(1)+"s":"N/A";

var modeLabel=curMode==="comm"?"Communications":curMode==="write"?"Writing":"Presentation";
var prompt='Expert Business English coach. Analyze this '+modeLabel+' session. Return ONLY raw JSON (no markdown backticks).\n\nSession: Mode='+modeLabel+', Duration='+dur+', User turns='+userTurns+', Words='+userWords+', Avg words/turn='+avgWpt+', Avg response time='+avgRt+'\n\nTRANSCRIPT:\n'+txText+'\n\nReturn JSON:\n{"cefrLevel":"B1/B2/C1/C2","cefrScore":0-100,"subScores":{"grammar":0-100,"vocabulary":0-100,"fluency":0-100,"taskAchievement":0-100},"bestMoment":{"quote":"exact user quote","why":"1 sentence"},"corrections":[{"said":"user said","better":"corrected","note":"why"}],"registerSuggestions":[{"said":"casual","try":"professional","context":"when"}],"phrasesToSteal":[{"phrase":"from agent","meaning":"definition","example":"sentence"}],"pronunciationNotes":[{"word":"word","phonetic":"IPA","tip":"advice"}],"confidenceAssessment":"1-2 sentences","mission":"one thing to practice next"}\n\n2-3 corrections, 2 register, 4-5 phrases, 2-3 pronunciation. Use ACTUAL words from transcript. Be honest but encouraging.';

try{
var res=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Authorization":"Bearer "+apiKey,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"user",content:prompt}],max_tokens:1500,temperature:0.7})});
var data=await res.json();
var raw=data.choices[0].message.content.replace(/```json\s*/g,"").replace(/```\s*/g,"").trim();
var rpt=JSON.parse(raw);
renderReport(rpt,dur,avgWpt,avgRt,modeLabel);
}catch(err){
document.getElementById("rptContent").innerHTML='<div class="rpt-s"><p style="color:#ef4444">Report error: '+esc(err.message)+'</p></div>'+rptActsHtml();
document.getElementById("rptContent").style.display="block";
document.getElementById("rptLoading").style.display="none";
}
}

function renderReport(r,dur,avgWpt,avgRt,modeLabel){
function sc(v){return v>=75?"#22c55e":v>=50?"#f59e0b":"#ef4444"}
var lvls={A2:20,B1:40,B2:60,C1:80,C2:95};
var ringPct=Math.min(95,Math.max(5,(lvls[r.cefrLevel]||50)-15+r.cefrScore*0.3));
var circ=2*Math.PI*44,off=circ*(1-ringPct/100);

var h='<div class="rpt-hdr"><h1>'+modeLabel+' Report</h1><div class="rpt-meta">'+dur+' ¬∑ Marcus Chen ¬∑ '+modeLabel+'</div></div>';

h+='<div class="score-ring-wrap"><div class="score-card"><div class="ring-c"><svg width="100" height="100" viewBox="0 0 100 100"><circle class="ring-bg" cx="50" cy="50" r="44"/><circle class="ring-fg" cx="50" cy="50" r="44" style="stroke:'+sc(ringPct)+';stroke-dasharray:'+circ+';stroke-dashoffset:'+off+'"/></svg><div class="ring-lbl"><div class="ring-lvl">'+r.cefrLevel+'</div><div class="ring-sub">Level</div></div></div><div class="score-dets">';
[["Grammar",r.subScores.grammar],["Vocabulary",r.subScores.vocabulary],["Fluency",r.subScores.fluency],["Task",r.subScores.taskAchievement]].forEach(function(s){
h+='<div class="sd-row"><div class="sd-lbl">'+s[0]+'</div><div class="sd-bar-w"><div class="sd-bar"><div class="sd-fill" style="width:'+s[1]+'%;background:'+sc(s[1])+'"></div></div><div class="sd-v" style="color:'+sc(s[1])+'">'+s[1]+'</div></div></div>';
});
h+='</div></div></div>';

h+='<div class="rpt-s"><h3><span class="ico">üí™</span>Confidence</h3><div class="conf-grid"><div class="conf-st"><div class="conf-v">'+avgWpt+'</div><div class="conf-l">Words / turn</div></div><div class="conf-st"><div class="conf-v">'+avgRt+'</div><div class="conf-l">Response time</div></div><div class="conf-st"><div class="conf-v">'+userTurns+'</div><div class="conf-l">Your turns</div></div></div><p style="font-size:13px;color:#94a3b8;margin-top:10px;line-height:1.5">'+esc(r.confidenceAssessment)+'</p></div>';

h+='<div class="rpt-s"><h3><span class="ico">‚≠ê</span>Your Best Moment</h3><div class="best-q">"'+esc(r.bestMoment.quote)+'"</div><div class="best-w">'+esc(r.bestMoment.why)+'</div></div>';

if(r.corrections&&r.corrections.length){h+='<div class="rpt-s"><h3><span class="ico">üîß</span>Try This Instead</h3>';r.corrections.forEach(function(c){h+='<div class="corr"><div class="corr-b">‚úó "'+esc(c.said)+'"</div><div class="corr-a">‚úì "'+esc(c.better)+'"</div><div class="corr-n">'+esc(c.note)+'</div></div>'});h+='</div>'}

if(r.registerSuggestions&&r.registerSuggestions.length){h+='<div class="rpt-s"><h3><span class="ico">üé©</span>Level Up Your Register</h3>';r.registerSuggestions.forEach(function(g){h+='<div class="reg-i"><div class="reg-said">You said: "'+esc(g.said)+'"</div><div class="reg-try">Try: "'+esc(g["try"])+'"</div><div class="reg-ctx">'+esc(g.context)+'</div></div>'});h+='</div>'}

if(r.phrasesToSteal&&r.phrasesToSteal.length){h+='<div class="rpt-s"><h3><span class="ico">üíé</span>Phrases to Steal</h3><div class="phrase-cards">';r.phrasesToSteal.forEach(function(p){h+='<div class="pcard" onclick="this.classList.toggle(\'open\')"><div class="pc-p">'+esc(p.phrase)+'</div><div class="pc-m">'+esc(p.meaning)+'</div><div class="pc-ex">"'+esc(p.example)+'"</div></div>'});h+='</div></div>'}

if(r.pronunciationNotes&&r.pronunciationNotes.length){h+='<div class="rpt-s"><h3><span class="ico">üó£Ô∏è</span>Pronunciation</h3>';r.pronunciationNotes.forEach(function(p){h+='<div class="pron-i"><div class="pron-w">'+esc(p.word)+'</div><div class="pron-ph">'+esc(p.phonetic)+'</div><div class="pron-tip">'+esc(p.tip)+'</div></div>'});h+='</div>'}

h+='<div class="rpt-s"><div class="mission-box"><div class="m-title">üéØ Your Mission</div><div class="m-text">'+esc(r.mission)+'</div></div></div>';
h+=rptActsHtml();

document.getElementById("rptContent").innerHTML=h;
document.getElementById("rptContent").style.display="block";
document.getElementById("rptLoading").style.display="none";
}

function rptActsHtml(){return'<div class="rpt-acts"><button class="rb-back" onclick="showScr(\'scrMode\')">New Session</button></div>'}

function esc(s){return s?String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}

document.addEventListener("keydown",function(e){
if(e.key==="Escape"&&document.getElementById("scrSession").classList.contains("active"))endSession();
if(e.key==="m"&&document.getElementById("scrSession").classList.contains("active")&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName))toggleMute();
});
</script>
</body>
</html>
